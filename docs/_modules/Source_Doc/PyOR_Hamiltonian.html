

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Source_Doc.PyOR_Hamiltonian &mdash; PyOR 1.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=92fd9be5" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/plot_directive.css" />

  
    <link rel="canonical" href="https://vthalakottoor.github.io/PyOR/_modules/Source_Doc/PyOR_Hamiltonian.html" />
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=8d563738"></script>
      <script src="../../_static/doctools.js?v=9a2dae69"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            PyOR
              <img src="../../_static/logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Source Code</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">PyOR Source Code</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html">PyOR Simulation Examples</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">PyOR</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">Source_Doc.PyOR_Hamiltonian</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for Source_Doc.PyOR_Hamiltonian</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">PyOR - Python On Resonance</span>

<span class="sd">Author:</span>
<span class="sd">    Vineeth Francis Thalakottoor Jose Chacko</span>

<span class="sd">Email:</span>
<span class="sd">    vineethfrancis.physics@gmail.com</span>

<span class="sd">Description:</span>
<span class="sd">    This file contains the `Hamiltonian` class, which provides routines for building </span>
<span class="sd">    various spin interaction Hamiltonians used in magnetic resonance simulations.</span>

<span class="sd">    Supported interactions may include Zeeman, dipolar coupling, scalar coupling, </span>
<span class="sd">    and quadrupolar interactions depending on system specifications.</span>
<span class="sd">&quot;&quot;&quot;</span>


<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">linalg</span> <span class="k">as</span> <span class="n">lina</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">interp1d</span>
<span class="kn">from</span> <span class="nn">scipy.linalg</span> <span class="kn">import</span> <span class="n">expm</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">StringIO</span>
<span class="kn">from</span> <span class="nn">joblib</span> <span class="kn">import</span> <span class="n">Parallel</span><span class="p">,</span> <span class="n">delayed</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">PyOR_PhysicalConstants</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">PyOR_Rotation</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">PyOR_SphericalTensors</span> <span class="k">as</span> <span class="n">ST</span>
    <span class="kn">from</span> <span class="nn">.PyOR_QuantumObject</span> <span class="kn">import</span> <span class="n">QunObj</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">PyOR_SignalProcessing</span> <span class="k">as</span> <span class="n">Spro</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">PyOR_PhysicalConstants</span>
    <span class="kn">import</span> <span class="nn">PyOR_Rotation</span>
    <span class="kn">import</span> <span class="nn">PyOR_SphericalTensors</span> <span class="k">as</span> <span class="nn">ST</span>
    <span class="kn">from</span> <span class="nn">PyOR_QuantumObject</span> <span class="kn">import</span> <span class="n">QunObj</span>
    <span class="kn">import</span> <span class="nn">PyOR_SignalProcessing</span> <span class="k">as</span> <span class="nn">Spro</span>


<div class="viewcode-block" id="Hamiltonian">
<a class="viewcode-back" href="../../modules.html#Source_Doc.PyOR_Hamiltonian.Hamiltonian">[docs]</a>
<span class="k">class</span> <span class="nc">Hamiltonian</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">class_QS</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the Hamiltonian class with quantum system parameters.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        class_QS : QuantumSystem</span>
<span class="sd">            Instance of the QuantumSystem class containing all system-level parameters</span>
<span class="sd">            like spin operators, gyromagnetic ratios, B0 field, offsets, etc.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span> <span class="o">=</span> <span class="n">class_QS</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">DTYPE_C</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">DTYPE_C</span>  <span class="c1"># Data type for complex matrices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hbar</span> <span class="o">=</span> <span class="n">PyOR_PhysicalConstants</span><span class="o">.</span><span class="n">constants</span><span class="p">(</span><span class="s2">&quot;hbar&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mu0</span> <span class="o">=</span> <span class="n">PyOR_PhysicalConstants</span><span class="o">.</span><span class="n">constants</span><span class="p">(</span><span class="s2">&quot;mu0&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Gamma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">Gamma</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">B0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">B0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">Offset</span>         
        <span class="bp">self</span><span class="o">.</span><span class="n">LarmorF</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LarmorFrequency</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LARMOR_F</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">LARMOR_F</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">SpinDic</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">LARMOR_F</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LarmorF</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="c1"># Inverse of 2 Pi – often used to convert between angular frequency and Hz</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Inverse2PI</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">InteractioTensor_AngularFrequency</span> <span class="o">=</span> <span class="kc">True</span>

<div class="viewcode-block" id="Hamiltonian.Update">
<a class="viewcode-back" href="../../modules.html#Source_Doc.PyOR_Hamiltonian.Hamiltonian.Update">[docs]</a>
    <span class="k">def</span> <span class="nf">Update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates internal parameters from the QuantumSystem instance.</span>
<span class="sd">        Useful when the quantum system is modified externally and </span>
<span class="sd">        the Hamiltonian needs to be resynchronized.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Gamma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">Gamma</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">B0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">B0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">Offset</span>         
        <span class="bp">self</span><span class="o">.</span><span class="n">LarmorF</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LarmorFrequency</span><span class="p">()</span></div>


<div class="viewcode-block" id="Hamiltonian.LarmorFrequency">
<a class="viewcode-back" href="../../modules.html#Source_Doc.PyOR_Hamiltonian.Hamiltonian.LarmorFrequency">[docs]</a>
    <span class="k">def</span> <span class="nf">LarmorFrequency</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the Larmor frequency (Ω₀) for each spin in the lab frame.</span>

<span class="sd">        Larmor frequency is given by:</span>
<span class="sd">            Ω₀ = -γ * B₀ - 2π * δ</span>
<span class="sd">        where:</span>
<span class="sd">            γ = gyromagnetic ratio,</span>
<span class="sd">            B₀ = magnetic field strength in Tesla,</span>
<span class="sd">            δ = chemical shift offset (in Hz)</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        numpy.ndarray</span>
<span class="sd">            Larmor frequencies (angular frequencies) for each spin in the system.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Gamma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Gamma</span>
        <span class="n">B0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">B0</span>
        <span class="n">Offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Offset</span>
        
        <span class="n">W0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">Nspins</span><span class="p">))</span>
        <span class="n">gamma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">Gamma</span><span class="p">)</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">Offset</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">Nspins</span><span class="p">):</span>
            <span class="n">W0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">gamma</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">B0</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">offset</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">print_Larmor</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Larmor Frequency in MHz: &quot;</span><span class="p">,</span> <span class="n">W0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mf">1.0e6</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">LarmorF</span> <span class="o">=</span> <span class="n">W0</span>
        <span class="k">return</span> <span class="n">W0</span></div>


<div class="viewcode-block" id="Hamiltonian.Zeeman">
<a class="viewcode-back" href="../../modules.html#Source_Doc.PyOR_Hamiltonian.Hamiltonian.Zeeman">[docs]</a>
    <span class="k">def</span> <span class="nf">Zeeman</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructs the Zeeman Hamiltonian in the laboratory frame.</span>

<span class="sd">        The Zeeman Hamiltonian is defined as:</span>

<span class="sd">        .. math::</span>

<span class="sd">            H_Z = \sum_i \omega_{0i} \cdot S_{zi}</span>

<span class="sd">        where :math:`\omega_{0i}` is the Larmor frequency of the *i*-th spin,  </span>
<span class="sd">        and :math:`S_{zi}` is the z-component spin operator.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        QunObj</span>
<span class="sd">            The Zeeman Hamiltonian represented as a quantum object.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">LarmorF</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LarmorF</span>
        <span class="n">Sz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">Sz_</span>

        <span class="n">Hz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">Vdim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">Vdim</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">DTYPE_C</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">Nspins</span><span class="p">):</span>
            <span class="n">Hz</span> <span class="o">+=</span> <span class="n">LarmorF</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">Sz</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">QunObj</span><span class="p">(</span><span class="n">Hz</span><span class="p">)</span></div>


<div class="viewcode-block" id="Hamiltonian.Zeeman_RotFrame">
<a class="viewcode-back" href="../../modules.html#Source_Doc.PyOR_Hamiltonian.Hamiltonian.Zeeman_RotFrame">[docs]</a>
    <span class="k">def</span> <span class="nf">Zeeman_RotFrame</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructs the Zeeman Hamiltonian in the rotating frame.</span>

<span class="sd">        The Hamiltonian is defined as:</span>

<span class="sd">        .. math::</span>

<span class="sd">            H_Z^{\mathrm{RF}} = \sum_i \left( \omega_{0i} - \omega_{\mathrm{RF}i} \right) S_{zi}</span>

<span class="sd">        where:</span>
<span class="sd">        - :math:`\omega_{0i}` is the Larmor frequency of the *i*-th spin</span>
<span class="sd">        - :math:`\omega_{\mathrm{RF}i}` is the rotating frame reference frequency</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        QunObj</span>
<span class="sd">            The Zeeman Hamiltonian in the rotating frame.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">LarmorF</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LarmorF</span>
        <span class="n">OmegaRF</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">OmegaRF</span>
        <span class="n">Sz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">Sz_</span>

        <span class="n">omegaRF</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">OmegaRF</span><span class="p">)</span>
        <span class="n">Hz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">Vdim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">Vdim</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">DTYPE_C</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">Nspins</span><span class="p">):</span>
            <span class="n">Hz</span> <span class="o">+=</span> <span class="p">(</span><span class="n">LarmorF</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">omegaRF</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">*</span> <span class="n">Sz</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="n">QunObj</span><span class="p">(</span><span class="n">Hz</span><span class="p">)</span></div>


<div class="viewcode-block" id="Hamiltonian.Zeeman_B1">
<a class="viewcode-back" href="../../modules.html#Source_Doc.PyOR_Hamiltonian.Hamiltonian.Zeeman_B1">[docs]</a>
    <span class="k">def</span> <span class="nf">Zeeman_B1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Omega1</span><span class="p">,</span> <span class="n">Omega1Phase</span><span class="p">):</span>  
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructs the B₁ Hamiltonian for RF excitation in the rotating frame.</span>

<span class="sd">        Assumes a continuous wave RF field:</span>
<span class="sd">            H_RF = ω₁ * [Sₓ cos(ϕ) + Sᵧ sin(ϕ)]</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        Omega1 : float</span>
<span class="sd">            RF amplitude in Hz (nutation frequency).</span>
<span class="sd">        Omega1Phase : float</span>
<span class="sd">            RF phase in degrees.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        QunObj</span>
<span class="sd">            Time-independent B₁ Hamiltonian in rotating frame.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Sx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">Sx_</span>
        <span class="n">Sy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">Sy_</span> 

        <span class="n">HzB1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">Vdim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">Vdim</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">DTYPE_C</span><span class="p">)</span>
        <span class="n">omega1</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">Omega1</span>
        <span class="n">Omega1Phase</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">Omega1Phase</span> <span class="o">/</span> <span class="mf">180.0</span>  <span class="c1"># convert degrees to radians</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">Nspins</span><span class="p">):</span>
            <span class="n">HzB1</span> <span class="o">+=</span> <span class="n">omega1</span> <span class="o">*</span> <span class="p">(</span><span class="n">Sx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">Omega1Phase</span><span class="p">)</span> <span class="o">+</span> <span class="n">Sy</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">Omega1Phase</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">QunObj</span><span class="p">(</span><span class="n">HzB1</span><span class="p">)</span></div>


<div class="viewcode-block" id="Hamiltonian.Zeeman_B1_Offresonance">
<a class="viewcode-back" href="../../modules.html#Source_Doc.PyOR_Hamiltonian.Hamiltonian.Zeeman_B1_Offresonance">[docs]</a>
    <span class="k">def</span> <span class="nf">Zeeman_B1_Offresonance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">Omega1</span><span class="p">,</span> <span class="n">Omega1freq</span><span class="p">,</span> <span class="n">Omega1Phase</span><span class="p">):</span>  
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructs a time-dependent Zeeman Hamiltonian for an off-resonant RF field.</span>

<span class="sd">        H(t) = ω₁ * [Sₓ cos(ω_RF * t + ϕ) + Sᵧ sin(ω_RF * t + ϕ)]</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        t : float</span>
<span class="sd">            Time in seconds.</span>
<span class="sd">        Omega1 : float</span>
<span class="sd">            RF amplitude (nutation frequency in Hz).</span>
<span class="sd">        Omega1freq : float</span>
<span class="sd">            RF frequency in Hz (off-resonance frequency in rotating frame).</span>
<span class="sd">        Omega1Phase : float</span>
<span class="sd">            Initial phase in degrees.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        numpy.ndarray</span>
<span class="sd">            Time-dependent Hamiltonian matrix (not a QunObj).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Sx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">Sx_</span>
        <span class="n">Sy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">Sy_</span> 
        
        <span class="n">HzB1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">Vdim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">Vdim</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">DTYPE_C</span><span class="p">)</span>
        <span class="n">omega1</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">Omega1</span>
        <span class="n">Omega1freq</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">Omega1freq</span>
        <span class="n">Omega1Phase</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">Omega1Phase</span> <span class="o">/</span> <span class="mf">180.0</span>  <span class="c1"># convert to radians</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">Nspins</span><span class="p">):</span>
            <span class="n">HzB1</span> <span class="o">+=</span> <span class="n">omega1</span> <span class="o">*</span> <span class="p">(</span><span class="n">Sx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">Omega1freq</span> <span class="o">*</span> <span class="n">t</span> <span class="o">+</span> <span class="n">Omega1Phase</span><span class="p">)</span> <span class="o">+</span>
                              <span class="n">Sy</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">Omega1freq</span> <span class="o">*</span> <span class="n">t</span> <span class="o">+</span> <span class="n">Omega1Phase</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">HzB1</span></div>


<div class="viewcode-block" id="Hamiltonian.Zeeman_B1_ShapedPulse">
<a class="viewcode-back" href="../../modules.html#Source_Doc.PyOR_Hamiltonian.Hamiltonian.Zeeman_B1_ShapedPulse">[docs]</a>
    <span class="k">def</span> <span class="nf">Zeeman_B1_ShapedPulse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">Omega1T</span><span class="p">,</span> <span class="n">Omega1freq</span><span class="p">,</span> <span class="n">Omega1PhaseT</span><span class="p">):</span>  
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructs time-dependent B₁ Hamiltonian with shaped amplitude and phase (e.g., Gaussian).</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        t : float</span>
<span class="sd">            Time (in seconds).</span>
<span class="sd">        Omega1T : callable</span>
<span class="sd">            Function returning time-varying RF amplitude (Hz).</span>
<span class="sd">        Omega1freq : float</span>
<span class="sd">            RF carrier frequency (Hz).</span>
<span class="sd">        Omega1PhaseT : callable</span>
<span class="sd">            Function returning time-varying phase (radians).</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        numpy.ndarray</span>
<span class="sd">            Time-dependent Hamiltonian matrix (not a QunObj).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Sx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">Sx_</span>
        <span class="n">Sy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">Sy_</span> 
        
        <span class="n">HzB1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">Vdim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">Vdim</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">DTYPE_C</span><span class="p">)</span>

        <span class="n">omega1</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">Omega1T</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">Omega1freq</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">Omega1freq</span>
        <span class="n">Omega1Phase</span> <span class="o">=</span> <span class="n">Omega1PhaseT</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">Nspins</span><span class="p">):</span>
            <span class="n">HzB1</span> <span class="o">+=</span> <span class="n">omega1</span> <span class="o">*</span> <span class="p">(</span><span class="n">Sx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">Omega1freq</span> <span class="o">*</span> <span class="n">t</span> <span class="o">+</span> <span class="n">Omega1Phase</span><span class="p">)</span> <span class="o">+</span>
                              <span class="n">Sy</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">Omega1freq</span> <span class="o">*</span> <span class="n">t</span> <span class="o">+</span> <span class="n">Omega1Phase</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">HzB1</span></div>


<div class="viewcode-block" id="Hamiltonian.Jcoupling">
<a class="viewcode-back" href="../../modules.html#Source_Doc.PyOR_Hamiltonian.Hamiltonian.Jcoupling">[docs]</a>
    <span class="k">def</span> <span class="nf">Jcoupling</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>    
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct full J-coupling Hamiltonian (isotropic scalar coupling).</span>

<span class="sd">        H_J = ∑₍i&lt;j₎ J_ij * (Sxᵢ·Sxⱼ + Syᵢ·Syⱼ + Szᵢ·Szⱼ)</span>

<span class="sd">        Inputs:</span>
<span class="sd">        -------</span>
<span class="sd">        J : 2D array (Hz)</span>
<span class="sd">            Symmetric matrix of J-couplings between spins i and j.</span>
<span class="sd">        Sx, Sy, Sz : list of ndarray</span>
<span class="sd">            Cartesian spin operators for all spins.</span>

<span class="sd">        Output:</span>
<span class="sd">        -------</span>
<span class="sd">        QunObj</span>
<span class="sd">            Full J-coupling Hamiltonian (angular frequency units).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">J</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">Jlist</span>
        <span class="n">Sx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">Sx_</span>
        <span class="n">Sy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">Sy_</span> 
        <span class="n">Sz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">Sz_</span>

        <span class="n">J</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">triu</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">J</span><span class="p">)</span>  <span class="c1"># Convert to angular frequency and zero lower triangle</span>
        <span class="n">Hj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">Vdim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">Vdim</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">DTYPE_C</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">Nspins</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">Nspins</span><span class="p">):</span>
                <span class="n">Hj</span> <span class="o">+=</span> <span class="n">J</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">Sx</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">Sx</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">+</span>
                                 <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">Sy</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">Sy</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">+</span>
                                 <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">Sz</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">Sz</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>

        <span class="k">return</span> <span class="n">QunObj</span><span class="p">(</span><span class="n">Hj</span><span class="p">)</span></div>


<div class="viewcode-block" id="Hamiltonian.Jcoupling_Weak">
<a class="viewcode-back" href="../../modules.html#Source_Doc.PyOR_Hamiltonian.Hamiltonian.Jcoupling_Weak">[docs]</a>
    <span class="k">def</span> <span class="nf">Jcoupling_Weak</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>    
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct simplified J-coupling Hamiltonian (weak coupling approximation).</span>

<span class="sd">        H_J ≈ ∑₍i&lt;j₎ J_ij * Szᵢ·Szⱼ</span>

<span class="sd">        Inputs:</span>
<span class="sd">        -------</span>
<span class="sd">        J : 2D array (Hz)</span>
<span class="sd">            Symmetric matrix of J-couplings between spins i and j.</span>
<span class="sd">        Sz : list of ndarray</span>
<span class="sd">            Z-component spin operators.</span>

<span class="sd">        Output:</span>
<span class="sd">        -------</span>
<span class="sd">        QunObj</span>
<span class="sd">            Simplified J-coupling Hamiltonian (angular frequency units).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">J</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">Jlist</span>
        <span class="n">Sz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">Sz_</span>

        <span class="n">J</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">triu</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">J</span><span class="p">)</span>
        <span class="n">Hj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">Vdim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">Vdim</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">DTYPE_C</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">Nspins</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">Nspins</span><span class="p">):</span>
                <span class="n">Hj</span> <span class="o">+=</span> <span class="n">J</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">Sz</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">Sz</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">QunObj</span><span class="p">(</span><span class="n">Hj</span><span class="p">)</span></div>


<div class="viewcode-block" id="Hamiltonian.Dipole_Coupling_Constant">
<a class="viewcode-back" href="../../modules.html#Source_Doc.PyOR_Hamiltonian.Hamiltonian.Dipole_Coupling_Constant">[docs]</a>
    <span class="k">def</span> <span class="nf">Dipole_Coupling_Constant</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Gamma1</span><span class="p">,</span> <span class="n">Gamma2</span><span class="p">,</span> <span class="n">distance</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the dipolar coupling constant between two spins.</span>

<span class="sd">        Formula:</span>
<span class="sd">        b_IS = - (μ₀ / 4π) * (γ₁ * γ₂ * ℏ) / r³</span>

<span class="sd">        Inputs:</span>
<span class="sd">        -------</span>
<span class="sd">        Gamma1 : float</span>
<span class="sd">            Gyromagnetic ratio of spin 1 (rad/T·s)</span>
<span class="sd">        Gamma2 : float</span>
<span class="sd">            Gyromagnetic ratio of spin 2 (rad/T·s)</span>
<span class="sd">        distance : float</span>
<span class="sd">            Inter-spin distance in meters</span>

<span class="sd">        Output:</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            Dipolar coupling constant in Hz</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;dipolar coupling constant (in Hz)&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mu0</span> <span class="o">*</span> <span class="n">Gamma1</span> <span class="o">*</span> <span class="n">Gamma2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">hbar</span> <span class="o">*</span> <span class="p">(</span><span class="n">distance</span> <span class="o">**</span> <span class="o">-</span><span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span></div>


<div class="viewcode-block" id="Hamiltonian.DDcoupling">
<a class="viewcode-back" href="../../modules.html#Source_Doc.PyOR_Hamiltonian.Hamiltonian.DDcoupling">[docs]</a>
    <span class="k">def</span> <span class="nf">DDcoupling</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct the Dipole-Dipole (DD) interaction Hamiltonian for all spin pairs.</span>

<span class="sd">        Supports:</span>
<span class="sd">        - Secular approximation (Hetero &amp; Homo)</span>
<span class="sd">        - Full interaction (All terms: secular, pseudo-secular, non-secular)</span>
<span class="sd">        - Individual components: A, B, C, D, E, F</span>

<span class="sd">        Inputs from class_QS:</span>
<span class="sd">        ----------------------</span>
<span class="sd">        - DipolePairs: list of (i, j) spin index pairs</span>
<span class="sd">        - DipoleAngle: list of (theta, phi) for each pair in degrees</span>
<span class="sd">        - DipolebIS: list of dipolar coupling constants (Hz)</span>
<span class="sd">        - Dipole_DipolarAlpabet: interaction mode (secular, All, A–F)</span>

<span class="sd">        Output:</span>
<span class="sd">        -------</span>
<span class="sd">        QunObj</span>
<span class="sd">            Complete DD coupling Hamiltonian in angular frequency units</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Sx</span><span class="p">,</span> <span class="n">Sy</span><span class="p">,</span> <span class="n">Sz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">Sx_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">Sy_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">Sz_</span>
        <span class="n">Sp</span><span class="p">,</span> <span class="n">Sm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">Sp_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">Sm_</span>

        <span class="n">thetaAll</span><span class="p">,</span> <span class="n">phiAll</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">DipoleAngle</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">thetaAll</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">thetaAll</span> <span class="o">/</span> <span class="mf">180.0</span>
        <span class="n">phiAll</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">phiAll</span> <span class="o">/</span> <span class="mf">180.0</span>

        <span class="n">Spin1</span><span class="p">,</span> <span class="n">Spin2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">DipolePairs</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">Hdd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">Vdim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">Vdim</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">DTYPE_C</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">bIS</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">Spin1</span><span class="p">,</span> <span class="n">Spin2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">Dipole_DipolarAlpabet</span><span class="p">,</span> <span class="n">thetaAll</span><span class="p">,</span> <span class="n">phiAll</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">DipolebIS</span><span class="p">):</span>

            <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;secular Hetronuclear&quot;</span><span class="p">:</span>
                <span class="n">A</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">Sz</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">Sz</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">Hdd</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">bIS</span> <span class="o">*</span> <span class="n">A</span>

            <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;secular Homonuclear&quot;</span><span class="p">:</span>
                <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">Sz</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">Sz</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">B</span> <span class="o">=</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">Sp</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">Sm</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">Sm</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">Sp</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span> <span class="o">*</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">Hdd</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">bIS</span> <span class="o">*</span> <span class="p">(</span><span class="n">A</span> <span class="o">+</span> <span class="n">B</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;All&quot;</span><span class="p">:</span>
                <span class="n">A</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">Sz</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">Sz</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">B</span> <span class="o">=</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">Sp</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">Sm</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">Sm</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">Sp</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span> <span class="o">*</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">C</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">Sp</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">Sz</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">Sz</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">Sp</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">phi</span><span class="p">)</span>
                <span class="n">D</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">Sm</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">Sz</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">Sz</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">Sm</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">phi</span><span class="p">)</span>
                <span class="n">E</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">Sp</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">Sp</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">phi</span><span class="p">)</span>
                <span class="n">F</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">Sm</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">Sm</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">phi</span><span class="p">)</span>
                <span class="n">Hdd</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">bIS</span> <span class="o">*</span> <span class="p">(</span><span class="n">A</span> <span class="o">+</span> <span class="n">B</span> <span class="o">+</span> <span class="n">C</span> <span class="o">+</span> <span class="n">D</span> <span class="o">+</span> <span class="n">E</span> <span class="o">+</span> <span class="n">F</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;D&quot;</span><span class="p">,</span> <span class="s2">&quot;E&quot;</span><span class="p">,</span> <span class="s2">&quot;F&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;A&quot;</span><span class="p">:</span>
                    <span class="n">Hdd</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">bIS</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">Sz</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">Sz</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;B&quot;</span><span class="p">:</span>
                    <span class="n">Hdd</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">bIS</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.25</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">Sp</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">Sm</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">Sm</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">Sp</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span> <span class="o">*</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;C&quot;</span><span class="p">:</span>
                    <span class="n">Hdd</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">bIS</span> <span class="o">*</span> <span class="p">((</span><span class="o">-</span><span class="mi">3</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">Sp</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">Sz</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">Sz</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">Sp</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">phi</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;D&quot;</span><span class="p">:</span>
                    <span class="n">Hdd</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">bIS</span> <span class="o">*</span> <span class="p">((</span><span class="o">-</span><span class="mi">3</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">Sm</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">Sz</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">Sz</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">Sm</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">phi</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;E&quot;</span><span class="p">:</span>
                    <span class="n">Hdd</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">bIS</span> <span class="o">*</span> <span class="p">((</span><span class="o">-</span><span class="mi">3</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">Sp</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">Sp</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">phi</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;F&quot;</span><span class="p">:</span>
                    <span class="n">Hdd</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">bIS</span> <span class="o">*</span> <span class="p">((</span><span class="o">-</span><span class="mi">3</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">Sm</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">Sm</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">phi</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">QunObj</span><span class="p">(</span><span class="n">Hdd</span><span class="p">)</span></div>


<div class="viewcode-block" id="Hamiltonian.Interaction_Hamiltonian_Catesian_Wigner">
<a class="viewcode-back" href="../../modules.html#Source_Doc.PyOR_Hamiltonian.Hamiltonian.Interaction_Hamiltonian_Catesian_Wigner">[docs]</a>
    <span class="k">def</span> <span class="nf">Interaction_Hamiltonian_Catesian_Wigner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">XQ</span><span class="p">,</span> <span class="n">ApafQ</span><span class="p">,</span> <span class="n">YQ</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        General interaction Hamiltonian using Wigner rotation of Cartesian tensors.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        XQ : str</span>
<span class="sd">            Name of the spin operator prefix (e.g., &quot;I&quot; or &quot;S&quot;).</span>
<span class="sd">        ApafQ : QunObj</span>
<span class="sd">            Interaction tensor in PAF (Principal Axis Frame).</span>
<span class="sd">        YQ : str</span>
<span class="sd">            Second spin operator prefix (e.g., &quot;S&quot;) or &quot;&quot; if interacting with external field.</span>
<span class="sd">        alpha, beta, gamma : float</span>
<span class="sd">            Euler angles in radians to rotate from PAF to lab frame.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        QunObj</span>
<span class="sd">            The interaction Hamiltonian.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">X</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="p">,</span> <span class="n">XQ</span> <span class="o">+</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="p">,</span> <span class="n">XQ</span> <span class="o">+</span> <span class="s2">&quot;y&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="p">,</span> <span class="n">XQ</span> <span class="o">+</span> <span class="s2">&quot;z&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">YQ</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">InteractioTensor_AngularFrequency</span><span class="p">:</span> <span class="c1"># Isotropic and Anisotropy are in angular frequency units</span>
                <span class="n">Y</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="mf">0.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">Vdim</span><span class="p">),</span>
                    <span class="mf">0.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">Vdim</span><span class="p">),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">Vdim</span><span class="p">)</span>
                <span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Y</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="mf">0.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">Vdim</span><span class="p">),</span>
                    <span class="mf">0.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">Vdim</span><span class="p">),</span>
                    <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="p">,</span> <span class="n">XQ</span><span class="p">)</span><span class="o">.</span><span class="n">gamma</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">B0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">Vdim</span><span class="p">)</span>
                <span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">Y</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="p">,</span> <span class="n">YQ</span> <span class="o">+</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="p">,</span> <span class="n">YQ</span> <span class="o">+</span> <span class="s2">&quot;y&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="p">,</span> <span class="n">YQ</span> <span class="o">+</span> <span class="s2">&quot;z&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">]</span>

        <span class="c1"># Spherical tensor decomposition</span>
        <span class="n">Sptensor</span> <span class="o">=</span> <span class="n">ST</span><span class="o">.</span><span class="n">MatrixToSphericalTensors</span><span class="p">(</span><span class="n">ApafQ</span><span class="p">)</span>

        <span class="n">T0</span> <span class="o">=</span> <span class="n">Sptensor</span><span class="p">[</span><span class="s2">&quot;rank0&quot;</span><span class="p">]</span>
        <span class="n">T11</span><span class="p">,</span> <span class="n">T10</span><span class="p">,</span> <span class="n">T1m1</span> <span class="o">=</span> <span class="n">Sptensor</span><span class="p">[</span><span class="s2">&quot;rank1&quot;</span><span class="p">]</span>
        <span class="n">T22</span><span class="p">,</span> <span class="n">T21</span><span class="p">,</span> <span class="n">T20</span><span class="p">,</span> <span class="n">T2m1</span><span class="p">,</span> <span class="n">T2m2</span> <span class="o">=</span> <span class="n">Sptensor</span><span class="p">[</span><span class="s2">&quot;rank2&quot;</span><span class="p">]</span>

        <span class="c1"># Wigner D-matrix rotation</span>
        <span class="n">Wigner_rank1</span> <span class="o">=</span> <span class="n">PyOR_Rotation</span><span class="o">.</span><span class="n">Wigner_D_Matrix</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span><span class="p">)</span>
        <span class="n">Wigner_rank2</span> <span class="o">=</span> <span class="n">PyOR_Rotation</span><span class="o">.</span><span class="n">Wigner_D_Matrix</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span><span class="p">)</span>

        <span class="n">Rot_rank1</span> <span class="o">=</span> <span class="n">Wigner_rank1</span><span class="o">.</span><span class="n">data</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">T11</span><span class="p">],</span> <span class="p">[</span><span class="n">T10</span><span class="p">],</span> <span class="p">[</span><span class="n">T1m1</span><span class="p">]])</span>
        <span class="n">Rot_rank2</span> <span class="o">=</span> <span class="n">Wigner_rank2</span><span class="o">.</span><span class="n">data</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">T22</span><span class="p">],</span> <span class="p">[</span><span class="n">T21</span><span class="p">],</span> <span class="p">[</span><span class="n">T20</span><span class="p">],</span> <span class="p">[</span><span class="n">T2m1</span><span class="p">],</span> <span class="p">[</span><span class="n">T2m2</span><span class="p">]])</span>

        <span class="n">Sptensor_f</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;rank0&quot;</span><span class="p">:</span> <span class="n">T0</span><span class="p">,</span>
            <span class="s2">&quot;rank1&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Rot_rank1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Rot_rank1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">Rot_rank1</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span>
            <span class="s2">&quot;rank2&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Rot_rank2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Rot_rank2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">Rot_rank2</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">Rot_rank2</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">Rot_rank2</span><span class="p">[</span><span class="mi">4</span><span class="p">]]</span>
        <span class="p">}</span>

        <span class="n">AQ</span> <span class="o">=</span> <span class="n">ST</span><span class="o">.</span><span class="n">SphericalTensorsToMatrix</span><span class="p">(</span><span class="n">Sptensor_f</span><span class="p">)</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">AQ</span><span class="o">.</span><span class="n">data</span>

        <span class="k">return</span> <span class="n">QunObj</span><span class="p">(</span>
            <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">@</span> <span class="n">Y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">@</span> <span class="n">Y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">X</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">@</span> <span class="n">Y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span>
            <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">@</span> <span class="n">Y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">@</span> <span class="n">Y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">X</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">@</span> <span class="n">Y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span>
            <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">@</span> <span class="n">Y</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">@</span> <span class="n">Y</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">X</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">@</span> <span class="n">Y</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="Hamiltonian.Interaction_Hamiltonian_Catesian_Euler">
<a class="viewcode-back" href="../../modules.html#Source_Doc.PyOR_Hamiltonian.Hamiltonian.Interaction_Hamiltonian_Catesian_Euler">[docs]</a>
    <span class="k">def</span> <span class="nf">Interaction_Hamiltonian_Catesian_Euler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">XQ</span><span class="p">,</span> <span class="n">AQ</span><span class="p">,</span> <span class="n">YQ</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Rotate interaction tensor using Euler angles and construct Hamiltonian in Cartesian space.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        XQ : str</span>
<span class="sd">            Name of spin operator (e.g., &quot;I&quot;)</span>
<span class="sd">        AQ : QunObj</span>
<span class="sd">            Interaction tensor in PAF</span>
<span class="sd">        YQ : str</span>
<span class="sd">            Second spin operator (e.g., &quot;S&quot;), or &quot;&quot; if external field</span>
<span class="sd">        alpha, beta, gamma : float</span>
<span class="sd">            Euler angles in radians</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        QunObj</span>
<span class="sd">            The interaction Hamiltonian</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">X</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="p">,</span> <span class="n">XQ</span> <span class="o">+</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="p">,</span> <span class="n">XQ</span> <span class="o">+</span> <span class="s2">&quot;y&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="p">,</span> <span class="n">XQ</span> <span class="o">+</span> <span class="s2">&quot;z&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">YQ</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">InteractioTensor_AngularFrequency</span><span class="p">:</span> <span class="c1"># Isotropic and Anisotropy are in angular frequency units</span>
                <span class="n">Y</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="mf">0.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">Vdim</span><span class="p">),</span>
                    <span class="mf">0.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">Vdim</span><span class="p">),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">Vdim</span><span class="p">)</span>
                <span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Y</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="mf">0.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">Vdim</span><span class="p">),</span>
                    <span class="mf">0.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">Vdim</span><span class="p">),</span>
                    <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="p">,</span> <span class="n">XQ</span><span class="p">)</span><span class="o">.</span><span class="n">gamma</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">B0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">Vdim</span><span class="p">)</span>
                <span class="p">]</span>
                                
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Y</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="p">,</span> <span class="n">YQ</span> <span class="o">+</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="p">,</span> <span class="n">YQ</span> <span class="o">+</span> <span class="s2">&quot;y&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="p">,</span> <span class="n">YQ</span> <span class="o">+</span> <span class="s2">&quot;z&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">]</span>

        <span class="n">Atemp</span> <span class="o">=</span> <span class="n">AQ</span><span class="o">.</span><span class="n">data</span>
        <span class="n">Rot</span> <span class="o">=</span> <span class="n">PyOR_Rotation</span><span class="o">.</span><span class="n">RotateEuler</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span><span class="p">)</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">Rot</span> <span class="o">@</span> <span class="n">Atemp</span> <span class="o">@</span> <span class="n">Rot</span><span class="o">.</span><span class="n">T</span>

        <span class="k">return</span> <span class="n">QunObj</span><span class="p">(</span>
            <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">@</span> <span class="n">Y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">@</span> <span class="n">Y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">X</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">@</span> <span class="n">Y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span>
            <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">@</span> <span class="n">Y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">@</span> <span class="n">Y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">X</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">@</span> <span class="n">Y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span>
            <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">@</span> <span class="n">Y</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">@</span> <span class="n">Y</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">X</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">@</span> <span class="n">Y</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="Hamiltonian.Interaction_Hamiltonian_SphericalTensor">
<a class="viewcode-back" href="../../modules.html#Source_Doc.PyOR_Hamiltonian.Hamiltonian.Interaction_Hamiltonian_SphericalTensor">[docs]</a>
    <span class="k">def</span> <span class="nf">Interaction_Hamiltonian_SphericalTensor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">ApafQ</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">string</span><span class="p">,</span> <span class="n">approx</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        General Hamiltonian using spherical tensor formalism.</span>

<span class="sd">        Reference:</span>
<span class="sd">        ----------</span>
<span class="sd">        Michael Mehring, Internal Spin Interactions and Rotations in Solids.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Transform tensor to lab frame via Wigner rotation</span>
        <span class="n">Sptensor</span> <span class="o">=</span> <span class="n">ST</span><span class="o">.</span><span class="n">MatrixToSphericalTensors</span><span class="p">(</span><span class="n">ApafQ</span><span class="p">)</span>
        <span class="n">AA0</span> <span class="o">=</span> <span class="n">Sptensor</span><span class="p">[</span><span class="s2">&quot;rank0&quot;</span><span class="p">]</span>
        <span class="n">AA11</span><span class="p">,</span> <span class="n">AA10</span><span class="p">,</span> <span class="n">AA1m1</span> <span class="o">=</span> <span class="n">Sptensor</span><span class="p">[</span><span class="s2">&quot;rank1&quot;</span><span class="p">]</span>
        <span class="n">AA22</span><span class="p">,</span> <span class="n">AA21</span><span class="p">,</span> <span class="n">AA20</span><span class="p">,</span> <span class="n">AA2m1</span><span class="p">,</span> <span class="n">AA2m2</span> <span class="o">=</span> <span class="n">Sptensor</span><span class="p">[</span><span class="s2">&quot;rank2&quot;</span><span class="p">]</span>

        <span class="n">Wigner_rank1</span> <span class="o">=</span> <span class="n">PyOR_Rotation</span><span class="o">.</span><span class="n">Wigner_D_Matrix</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span><span class="p">)</span> <span class="c1"># Note the negative sign !!!</span>
        <span class="n">Wigner_rank2</span> <span class="o">=</span> <span class="n">PyOR_Rotation</span><span class="o">.</span><span class="n">Wigner_D_Matrix</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span><span class="p">)</span>

        <span class="n">Rot_rank1</span> <span class="o">=</span> <span class="n">Wigner_rank1</span><span class="o">.</span><span class="n">data</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">AA11</span><span class="p">],</span> <span class="p">[</span><span class="n">AA10</span><span class="p">],</span> <span class="p">[</span><span class="n">AA1m1</span><span class="p">]])</span>
        <span class="n">Rot_rank2</span> <span class="o">=</span> <span class="n">Wigner_rank2</span><span class="o">.</span><span class="n">data</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">AA22</span><span class="p">],</span> <span class="p">[</span><span class="n">AA21</span><span class="p">],</span> <span class="p">[</span><span class="n">AA20</span><span class="p">],</span> <span class="p">[</span><span class="n">AA2m1</span><span class="p">],</span> <span class="p">[</span><span class="n">AA2m2</span><span class="p">]])</span>

        <span class="c1"># Apply gyromagnetic ratio scaling for spin-field</span>
        <span class="k">if</span> <span class="n">string</span> <span class="o">==</span> <span class="s2">&quot;spin-field&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">InteractioTensor_AngularFrequency</span><span class="p">:</span> <span class="c1"># Isotropic and Anisotropy are in angular frequency units</span>
                <span class="n">A0</span> <span class="o">=</span> <span class="n">AA0</span>
                <span class="n">A11</span><span class="p">,</span> <span class="n">A10</span><span class="p">,</span> <span class="n">A1m1</span> <span class="o">=</span> <span class="n">Rot_rank1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Rot_rank1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">Rot_rank1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">A22</span><span class="p">,</span> <span class="n">A21</span><span class="p">,</span> <span class="n">A20</span><span class="p">,</span> <span class="n">A2m1</span><span class="p">,</span> <span class="n">A2m2</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">Rot_rank2</span><span class="p">]</span>

                <span class="n">Im</span><span class="p">,</span> <span class="n">Ip</span><span class="p">,</span> <span class="n">Iz</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="p">,</span> <span class="n">X</span> <span class="o">+</span> <span class="s2">&quot;m&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="p">,</span> <span class="n">X</span> <span class="o">+</span> <span class="s2">&quot;p&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="p">,</span> <span class="n">X</span> <span class="o">+</span> <span class="s2">&quot;z&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>

                <span class="c1"># Tensor operators for spin-field</span>
                <span class="n">T0</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span> <span class="o">*</span> <span class="n">Iz</span>
                <span class="n">T10</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="o">*</span> <span class="n">Iz</span>
                <span class="n">T11</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">Ip</span>
                <span class="n">T1m1</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">Im</span>
                <span class="n">T20</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span> <span class="o">*</span> <span class="n">Iz</span>
                <span class="n">T21</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">Ip</span>
                <span class="n">T2m1</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">Im</span>
                <span class="n">T22</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="o">*</span> <span class="n">Iz</span>
                <span class="n">T2m2</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="o">*</span> <span class="n">Iz</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">gamma</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">gamma</span>
                <span class="n">A0</span> <span class="o">=</span> <span class="n">gamma</span> <span class="o">*</span> <span class="n">AA0</span>
                <span class="n">A11</span><span class="p">,</span> <span class="n">A10</span><span class="p">,</span> <span class="n">A1m1</span> <span class="o">=</span> <span class="n">gamma</span> <span class="o">*</span> <span class="n">Rot_rank1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">gamma</span> <span class="o">*</span> <span class="n">Rot_rank1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">gamma</span> <span class="o">*</span> <span class="n">Rot_rank1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">A22</span><span class="p">,</span> <span class="n">A21</span><span class="p">,</span> <span class="n">A20</span><span class="p">,</span> <span class="n">A2m1</span><span class="p">,</span> <span class="n">A2m2</span> <span class="o">=</span> <span class="p">[</span><span class="n">gamma</span> <span class="o">*</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">Rot_rank2</span><span class="p">]</span>

                <span class="n">Im</span><span class="p">,</span> <span class="n">Ip</span><span class="p">,</span> <span class="n">Iz</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="p">,</span> <span class="n">X</span> <span class="o">+</span> <span class="s2">&quot;m&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="p">,</span> <span class="n">X</span> <span class="o">+</span> <span class="s2">&quot;p&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="p">,</span> <span class="n">X</span> <span class="o">+</span> <span class="s2">&quot;z&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
                <span class="n">B0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">B0</span>

                <span class="c1"># Tensor operators for spin-field</span>
                <span class="n">T0</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span> <span class="o">*</span> <span class="n">Iz</span> <span class="o">*</span> <span class="n">B0</span>
                <span class="n">T10</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="o">*</span> <span class="n">Iz</span>
                <span class="n">T11</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">Ip</span> <span class="o">*</span> <span class="n">B0</span>
                <span class="n">T1m1</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">Im</span> <span class="o">*</span> <span class="n">B0</span>
                <span class="n">T20</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span> <span class="o">*</span> <span class="n">Iz</span> <span class="o">*</span> <span class="n">B0</span>
                <span class="n">T21</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">Ip</span> <span class="o">*</span> <span class="n">B0</span>
                <span class="n">T2m1</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">Im</span> <span class="o">*</span> <span class="n">B0</span>
                <span class="n">T22</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="o">*</span> <span class="n">Iz</span>
                <span class="n">T2m2</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="o">*</span> <span class="n">Iz</span>

        <span class="k">elif</span> <span class="n">string</span> <span class="o">==</span> <span class="s2">&quot;spin-spin&quot;</span><span class="p">:</span>
            <span class="n">A0</span> <span class="o">=</span> <span class="n">AA0</span>
            <span class="n">A11</span><span class="p">,</span> <span class="n">A10</span><span class="p">,</span> <span class="n">A1m1</span> <span class="o">=</span> <span class="n">Rot_rank1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Rot_rank1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">Rot_rank1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">A22</span><span class="p">,</span> <span class="n">A21</span><span class="p">,</span> <span class="n">A20</span><span class="p">,</span> <span class="n">A2m1</span><span class="p">,</span> <span class="n">A2m2</span> <span class="o">=</span> <span class="n">Rot_rank2</span>

            <span class="n">Im</span><span class="p">,</span> <span class="n">Ip</span><span class="p">,</span> <span class="n">Iz</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="p">,</span> <span class="n">X</span> <span class="o">+</span> <span class="s2">&quot;m&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="p">,</span> <span class="n">X</span> <span class="o">+</span> <span class="s2">&quot;p&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="p">,</span> <span class="n">X</span> <span class="o">+</span> <span class="s2">&quot;z&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
            <span class="n">Sm</span><span class="p">,</span> <span class="n">Sp</span><span class="p">,</span> <span class="n">Sz</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="p">,</span> <span class="n">Y</span> <span class="o">+</span> <span class="s2">&quot;m&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="p">,</span> <span class="n">Y</span> <span class="o">+</span> <span class="s2">&quot;p&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="p">,</span> <span class="n">Y</span> <span class="o">+</span> <span class="s2">&quot;z&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>

            <span class="n">Ix</span><span class="p">,</span> <span class="n">Iy</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">Ip</span> <span class="o">+</span> <span class="n">Im</span><span class="p">),</span> <span class="o">-</span><span class="mf">0.5</span><span class="n">j</span> <span class="o">*</span> <span class="p">(</span><span class="n">Ip</span> <span class="o">-</span> <span class="n">Im</span><span class="p">)</span>
            <span class="n">Sx</span><span class="p">,</span> <span class="n">Sy</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">Sp</span> <span class="o">+</span> <span class="n">Sm</span><span class="p">),</span> <span class="o">-</span><span class="mf">0.5</span><span class="n">j</span> <span class="o">*</span> <span class="p">(</span><span class="n">Sp</span> <span class="o">-</span> <span class="n">Sm</span><span class="p">)</span>

            <span class="c1"># Tensor products for spin-spin interaction</span>
            <span class="n">T0</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="n">Ix</span> <span class="o">@</span> <span class="n">Sx</span> <span class="o">+</span> <span class="n">Iy</span> <span class="o">@</span> <span class="n">Sy</span> <span class="o">+</span> <span class="n">Iz</span> <span class="o">@</span> <span class="n">Sz</span><span class="p">)</span>
            <span class="n">T10</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="n">Ip</span> <span class="o">@</span> <span class="n">Sm</span> <span class="o">-</span> <span class="n">Im</span> <span class="o">@</span> <span class="n">Sp</span><span class="p">)</span>
            <span class="n">T11</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">Iz</span> <span class="o">@</span> <span class="n">Sp</span> <span class="o">-</span> <span class="n">Ip</span> <span class="o">@</span> <span class="n">Sz</span><span class="p">)</span>
            <span class="n">T1m1</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">Iz</span> <span class="o">@</span> <span class="n">Sm</span> <span class="o">-</span> <span class="n">Im</span> <span class="o">@</span> <span class="n">Sz</span><span class="p">)</span>
            <span class="n">T20</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">Iz</span> <span class="o">@</span> <span class="n">Sz</span> <span class="o">-</span> <span class="p">(</span><span class="n">Ix</span> <span class="o">@</span> <span class="n">Sx</span> <span class="o">+</span> <span class="n">Iy</span> <span class="o">@</span> <span class="n">Sy</span> <span class="o">+</span> <span class="n">Iz</span> <span class="o">@</span> <span class="n">Sz</span><span class="p">))</span>
            <span class="n">T21</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">Iz</span> <span class="o">@</span> <span class="n">Sp</span> <span class="o">+</span> <span class="n">Ip</span> <span class="o">@</span> <span class="n">Sz</span><span class="p">)</span>
            <span class="n">T2m1</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">Iz</span> <span class="o">@</span> <span class="n">Sm</span> <span class="o">+</span> <span class="n">Im</span> <span class="o">@</span> <span class="n">Sz</span><span class="p">)</span>
            <span class="n">T22</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">Ip</span> <span class="o">@</span> <span class="n">Sp</span>
            <span class="n">T2m2</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">Im</span> <span class="o">@</span> <span class="n">Sm</span>

        <span class="c1"># Final assembly</span>
        <span class="k">if</span> <span class="n">approx</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">QunObj</span><span class="p">(</span>
                <span class="n">A0</span> <span class="o">*</span> <span class="n">T0</span> <span class="o">+</span> <span class="n">A10</span> <span class="o">*</span> <span class="n">T10</span> <span class="o">-</span> <span class="p">(</span><span class="n">A11</span> <span class="o">*</span> <span class="n">T1m1</span> <span class="o">+</span> <span class="n">A1m1</span> <span class="o">*</span> <span class="n">T11</span><span class="p">)</span> <span class="o">+</span>
                <span class="n">A20</span> <span class="o">*</span> <span class="n">T20</span> <span class="o">-</span> <span class="p">(</span><span class="n">A21</span> <span class="o">*</span> <span class="n">T2m1</span> <span class="o">+</span> <span class="n">A2m1</span> <span class="o">*</span> <span class="n">T21</span><span class="p">)</span> <span class="o">+</span> <span class="n">A22</span> <span class="o">*</span> <span class="n">T2m2</span> <span class="o">+</span> <span class="n">A2m2</span> <span class="o">*</span> <span class="n">T22</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">approx</span> <span class="o">==</span> <span class="s2">&quot;secular&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">QunObj</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span>
                <span class="n">A0</span> <span class="o">*</span> <span class="n">T0</span> <span class="o">+</span> <span class="n">A10</span> <span class="o">*</span> <span class="n">T10</span> <span class="o">-</span> <span class="p">(</span><span class="n">A11</span> <span class="o">*</span> <span class="n">T1m1</span> <span class="o">+</span> <span class="n">A1m1</span> <span class="o">*</span> <span class="n">T11</span><span class="p">)</span> <span class="o">+</span>
                <span class="n">A20</span> <span class="o">*</span> <span class="n">T20</span> <span class="o">-</span> <span class="p">(</span><span class="n">A21</span> <span class="o">*</span> <span class="n">T2m1</span> <span class="o">+</span> <span class="n">A2m1</span> <span class="o">*</span> <span class="n">T21</span><span class="p">)</span> <span class="o">+</span> <span class="n">A22</span> <span class="o">*</span> <span class="n">T2m2</span> <span class="o">+</span> <span class="n">A2m2</span> <span class="o">*</span> <span class="n">T22</span>
            <span class="p">)))</span>
        <span class="k">if</span> <span class="n">approx</span> <span class="o">==</span> <span class="s2">&quot;secular + pseudosecular&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">QunObj</span><span class="p">(</span><span class="n">A0</span> <span class="o">*</span> <span class="n">T0</span> <span class="o">+</span> <span class="n">A10</span> <span class="o">*</span> <span class="n">T10</span> <span class="o">+</span> <span class="n">A20</span> <span class="o">*</span> <span class="n">T20</span><span class="p">)</span></div>


<div class="viewcode-block" id="Hamiltonian.Interaction_Hamiltonian_MAS_SphericalTensor">
<a class="viewcode-back" href="../../modules.html#Source_Doc.PyOR_Hamiltonian.Hamiltonian.Interaction_Hamiltonian_MAS_SphericalTensor">[docs]</a>
    <span class="k">def</span> <span class="nf">Interaction_Hamiltonian_MAS_SphericalTensor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">ApafQ</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">string</span><span class="p">,</span> <span class="n">approx</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">alpha1</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">beta1</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">gamma1</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        General Hamiltonian using spherical tensor formalism for Magical Angle Spinning (MAS).</span>

<span class="sd">        Reference:</span>
<span class="sd">        ----------</span>
<span class="sd">        Michael Mehring, Internal Spin Interactions and Rotations in Solids.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Transform tensor to lab frame via Wigner rotation</span>
        <span class="n">Sptensor</span> <span class="o">=</span> <span class="n">ST</span><span class="o">.</span><span class="n">MatrixToSphericalTensors</span><span class="p">(</span><span class="n">ApafQ</span><span class="p">)</span>
        <span class="n">AA0</span> <span class="o">=</span> <span class="n">Sptensor</span><span class="p">[</span><span class="s2">&quot;rank0&quot;</span><span class="p">]</span>
        <span class="n">AA11</span><span class="p">,</span> <span class="n">AA10</span><span class="p">,</span> <span class="n">AA1m1</span> <span class="o">=</span> <span class="n">Sptensor</span><span class="p">[</span><span class="s2">&quot;rank1&quot;</span><span class="p">]</span>
        <span class="n">AA22</span><span class="p">,</span> <span class="n">AA21</span><span class="p">,</span> <span class="n">AA20</span><span class="p">,</span> <span class="n">AA2m1</span><span class="p">,</span> <span class="n">AA2m2</span> <span class="o">=</span> <span class="n">Sptensor</span><span class="p">[</span><span class="s2">&quot;rank2&quot;</span><span class="p">]</span>

        <span class="n">Wigner_rank11</span> <span class="o">=</span> <span class="n">PyOR_Rotation</span><span class="o">.</span><span class="n">Wigner_D_Matrix</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span><span class="p">)</span> <span class="c1"># PAF to RAF. Note the negative sign !!!</span>
        <span class="n">Wigner_rank22</span> <span class="o">=</span> <span class="n">PyOR_Rotation</span><span class="o">.</span><span class="n">Wigner_D_Matrix</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span><span class="p">)</span> <span class="c1"># PAF to RAF. Note the negative sign !!!</span>

        <span class="n">Wigner_rank1</span> <span class="o">=</span> <span class="n">PyOR_Rotation</span><span class="o">.</span><span class="n">Wigner_D_Matrix</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="n">alpha1</span><span class="p">,</span> <span class="n">beta1</span><span class="p">,</span> <span class="n">gamma1</span><span class="p">)</span> <span class="c1"># RAF to LAB. Note the negative sign !!!</span>
        <span class="n">Wigner_rank2</span> <span class="o">=</span> <span class="n">PyOR_Rotation</span><span class="o">.</span><span class="n">Wigner_D_Matrix</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="n">alpha1</span><span class="p">,</span> <span class="n">beta1</span><span class="p">,</span> <span class="n">gamma1</span><span class="p">)</span> <span class="c1"># RAF to LAB. Note the negative sign !!!</span>

        <span class="n">Rot_rank1</span> <span class="o">=</span> <span class="n">Wigner_rank1</span><span class="o">.</span><span class="n">data</span> <span class="o">@</span> <span class="n">Wigner_rank11</span><span class="o">.</span><span class="n">data</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">AA11</span><span class="p">],</span> <span class="p">[</span><span class="n">AA10</span><span class="p">],</span> <span class="p">[</span><span class="n">AA1m1</span><span class="p">]])</span>
        <span class="n">Rot_rank2</span> <span class="o">=</span> <span class="n">Wigner_rank2</span><span class="o">.</span><span class="n">data</span> <span class="o">@</span> <span class="n">Wigner_rank22</span><span class="o">.</span><span class="n">data</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">AA22</span><span class="p">],</span> <span class="p">[</span><span class="n">AA21</span><span class="p">],</span> <span class="p">[</span><span class="n">AA20</span><span class="p">],</span> <span class="p">[</span><span class="n">AA2m1</span><span class="p">],</span> <span class="p">[</span><span class="n">AA2m2</span><span class="p">]])</span>

        <span class="c1"># Apply gyromagnetic ratio scaling for spin-field</span>
        <span class="k">if</span> <span class="n">string</span> <span class="o">==</span> <span class="s2">&quot;spin-field&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">InteractioTensor_AngularFrequency</span><span class="p">:</span> <span class="c1"># Isotropic and Anisotropy are in angular frequency units</span>
                <span class="n">A0</span> <span class="o">=</span> <span class="n">AA0</span>
                <span class="n">A11</span><span class="p">,</span> <span class="n">A10</span><span class="p">,</span> <span class="n">A1m1</span> <span class="o">=</span> <span class="n">Rot_rank1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Rot_rank1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">Rot_rank1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">A22</span><span class="p">,</span> <span class="n">A21</span><span class="p">,</span> <span class="n">A20</span><span class="p">,</span> <span class="n">A2m1</span><span class="p">,</span> <span class="n">A2m2</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">Rot_rank2</span><span class="p">]</span>

                <span class="n">Im</span><span class="p">,</span> <span class="n">Ip</span><span class="p">,</span> <span class="n">Iz</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="p">,</span> <span class="n">X</span> <span class="o">+</span> <span class="s2">&quot;m&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="p">,</span> <span class="n">X</span> <span class="o">+</span> <span class="s2">&quot;p&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="p">,</span> <span class="n">X</span> <span class="o">+</span> <span class="s2">&quot;z&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>

                <span class="c1"># Tensor operators for spin-field</span>
                <span class="n">T0</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span> <span class="o">*</span> <span class="n">Iz</span>
                <span class="n">T10</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="o">*</span> <span class="n">Iz</span>
                <span class="n">T11</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">Ip</span>
                <span class="n">T1m1</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">Im</span>
                <span class="n">T20</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span> <span class="o">*</span> <span class="n">Iz</span>
                <span class="n">T21</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">Ip</span>
                <span class="n">T2m1</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">Im</span>
                <span class="n">T22</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="o">*</span> <span class="n">Iz</span>
                <span class="n">T2m2</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="o">*</span> <span class="n">Iz</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">gamma</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">gamma</span>
                <span class="n">A0</span> <span class="o">=</span> <span class="n">gamma</span> <span class="o">*</span> <span class="n">AA0</span>
                <span class="n">A11</span><span class="p">,</span> <span class="n">A10</span><span class="p">,</span> <span class="n">A1m1</span> <span class="o">=</span> <span class="n">gamma</span> <span class="o">*</span> <span class="n">Rot_rank1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">gamma</span> <span class="o">*</span> <span class="n">Rot_rank1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">gamma</span> <span class="o">*</span> <span class="n">Rot_rank1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">A22</span><span class="p">,</span> <span class="n">A21</span><span class="p">,</span> <span class="n">A20</span><span class="p">,</span> <span class="n">A2m1</span><span class="p">,</span> <span class="n">A2m2</span> <span class="o">=</span> <span class="p">[</span><span class="n">gamma</span> <span class="o">*</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">Rot_rank2</span><span class="p">]</span>

                <span class="n">Im</span><span class="p">,</span> <span class="n">Ip</span><span class="p">,</span> <span class="n">Iz</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="p">,</span> <span class="n">X</span> <span class="o">+</span> <span class="s2">&quot;m&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="p">,</span> <span class="n">X</span> <span class="o">+</span> <span class="s2">&quot;p&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="p">,</span> <span class="n">X</span> <span class="o">+</span> <span class="s2">&quot;z&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
                <span class="n">B0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">B0</span>

                <span class="c1"># Tensor operators for spin-field</span>
                <span class="n">T0</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span> <span class="o">*</span> <span class="n">Iz</span> <span class="o">*</span> <span class="n">B0</span>
                <span class="n">T10</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="o">*</span> <span class="n">Iz</span>
                <span class="n">T11</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">Ip</span> <span class="o">*</span> <span class="n">B0</span>
                <span class="n">T1m1</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">Im</span> <span class="o">*</span> <span class="n">B0</span>
                <span class="n">T20</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span> <span class="o">*</span> <span class="n">Iz</span> <span class="o">*</span> <span class="n">B0</span>
                <span class="n">T21</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">Ip</span> <span class="o">*</span> <span class="n">B0</span>
                <span class="n">T2m1</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">Im</span> <span class="o">*</span> <span class="n">B0</span>
                <span class="n">T22</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="o">*</span> <span class="n">Iz</span>
                <span class="n">T2m2</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="o">*</span> <span class="n">Iz</span>

        <span class="k">elif</span> <span class="n">string</span> <span class="o">==</span> <span class="s2">&quot;spin-spin&quot;</span><span class="p">:</span>
            <span class="n">A0</span> <span class="o">=</span> <span class="n">AA0</span>
            <span class="n">A11</span><span class="p">,</span> <span class="n">A10</span><span class="p">,</span> <span class="n">A1m1</span> <span class="o">=</span> <span class="n">Rot_rank1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Rot_rank1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">Rot_rank1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">A22</span><span class="p">,</span> <span class="n">A21</span><span class="p">,</span> <span class="n">A20</span><span class="p">,</span> <span class="n">A2m1</span><span class="p">,</span> <span class="n">A2m2</span> <span class="o">=</span> <span class="n">Rot_rank2</span>

            <span class="n">Im</span><span class="p">,</span> <span class="n">Ip</span><span class="p">,</span> <span class="n">Iz</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="p">,</span> <span class="n">X</span> <span class="o">+</span> <span class="s2">&quot;m&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="p">,</span> <span class="n">X</span> <span class="o">+</span> <span class="s2">&quot;p&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="p">,</span> <span class="n">X</span> <span class="o">+</span> <span class="s2">&quot;z&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
            <span class="n">Sm</span><span class="p">,</span> <span class="n">Sp</span><span class="p">,</span> <span class="n">Sz</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="p">,</span> <span class="n">Y</span> <span class="o">+</span> <span class="s2">&quot;m&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="p">,</span> <span class="n">Y</span> <span class="o">+</span> <span class="s2">&quot;p&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="p">,</span> <span class="n">Y</span> <span class="o">+</span> <span class="s2">&quot;z&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>

            <span class="n">Ix</span><span class="p">,</span> <span class="n">Iy</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">Ip</span> <span class="o">+</span> <span class="n">Im</span><span class="p">),</span> <span class="o">-</span><span class="mf">0.5</span><span class="n">j</span> <span class="o">*</span> <span class="p">(</span><span class="n">Ip</span> <span class="o">-</span> <span class="n">Im</span><span class="p">)</span>
            <span class="n">Sx</span><span class="p">,</span> <span class="n">Sy</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">Sp</span> <span class="o">+</span> <span class="n">Sm</span><span class="p">),</span> <span class="o">-</span><span class="mf">0.5</span><span class="n">j</span> <span class="o">*</span> <span class="p">(</span><span class="n">Sp</span> <span class="o">-</span> <span class="n">Sm</span><span class="p">)</span>

            <span class="c1"># Tensor products for spin-spin interaction</span>
            <span class="n">T0</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="n">Ix</span> <span class="o">@</span> <span class="n">Sx</span> <span class="o">+</span> <span class="n">Iy</span> <span class="o">@</span> <span class="n">Sy</span> <span class="o">+</span> <span class="n">Iz</span> <span class="o">@</span> <span class="n">Sz</span><span class="p">)</span>
            <span class="n">T10</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="n">Ip</span> <span class="o">@</span> <span class="n">Sm</span> <span class="o">-</span> <span class="n">Im</span> <span class="o">@</span> <span class="n">Sp</span><span class="p">)</span>
            <span class="n">T11</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">Iz</span> <span class="o">@</span> <span class="n">Sp</span> <span class="o">-</span> <span class="n">Ip</span> <span class="o">@</span> <span class="n">Sz</span><span class="p">)</span>
            <span class="n">T1m1</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">Iz</span> <span class="o">@</span> <span class="n">Sm</span> <span class="o">-</span> <span class="n">Im</span> <span class="o">@</span> <span class="n">Sz</span><span class="p">)</span>
            <span class="n">T20</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">Iz</span> <span class="o">@</span> <span class="n">Sz</span> <span class="o">-</span> <span class="p">(</span><span class="n">Ix</span> <span class="o">@</span> <span class="n">Sx</span> <span class="o">+</span> <span class="n">Iy</span> <span class="o">@</span> <span class="n">Sy</span> <span class="o">+</span> <span class="n">Iz</span> <span class="o">@</span> <span class="n">Sz</span><span class="p">))</span>
            <span class="n">T21</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">Iz</span> <span class="o">@</span> <span class="n">Sp</span> <span class="o">+</span> <span class="n">Ip</span> <span class="o">@</span> <span class="n">Sz</span><span class="p">)</span>
            <span class="n">T2m1</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">Iz</span> <span class="o">@</span> <span class="n">Sm</span> <span class="o">+</span> <span class="n">Im</span> <span class="o">@</span> <span class="n">Sz</span><span class="p">)</span>
            <span class="n">T22</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">Ip</span> <span class="o">@</span> <span class="n">Sp</span>
            <span class="n">T2m2</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">Im</span> <span class="o">@</span> <span class="n">Sm</span>

        <span class="c1"># Final assembly</span>
        <span class="k">if</span> <span class="n">approx</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">QunObj</span><span class="p">(</span>
                <span class="n">A0</span> <span class="o">*</span> <span class="n">T0</span> <span class="o">+</span> <span class="n">A10</span> <span class="o">*</span> <span class="n">T10</span> <span class="o">-</span> <span class="p">(</span><span class="n">A11</span> <span class="o">*</span> <span class="n">T1m1</span> <span class="o">+</span> <span class="n">A1m1</span> <span class="o">*</span> <span class="n">T11</span><span class="p">)</span> <span class="o">+</span>
                <span class="n">A20</span> <span class="o">*</span> <span class="n">T20</span> <span class="o">-</span> <span class="p">(</span><span class="n">A21</span> <span class="o">*</span> <span class="n">T2m1</span> <span class="o">+</span> <span class="n">A2m1</span> <span class="o">*</span> <span class="n">T21</span><span class="p">)</span> <span class="o">+</span> <span class="n">A22</span> <span class="o">*</span> <span class="n">T2m2</span> <span class="o">+</span> <span class="n">A2m2</span> <span class="o">*</span> <span class="n">T22</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">approx</span> <span class="o">==</span> <span class="s2">&quot;secular&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">QunObj</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span>
                <span class="n">A0</span> <span class="o">*</span> <span class="n">T0</span> <span class="o">+</span> <span class="n">A10</span> <span class="o">*</span> <span class="n">T10</span> <span class="o">-</span> <span class="p">(</span><span class="n">A11</span> <span class="o">*</span> <span class="n">T1m1</span> <span class="o">+</span> <span class="n">A1m1</span> <span class="o">*</span> <span class="n">T11</span><span class="p">)</span> <span class="o">+</span>
                <span class="n">A20</span> <span class="o">*</span> <span class="n">T20</span> <span class="o">-</span> <span class="p">(</span><span class="n">A21</span> <span class="o">*</span> <span class="n">T2m1</span> <span class="o">+</span> <span class="n">A2m1</span> <span class="o">*</span> <span class="n">T21</span><span class="p">)</span> <span class="o">+</span> <span class="n">A22</span> <span class="o">*</span> <span class="n">T2m2</span> <span class="o">+</span> <span class="n">A2m2</span> <span class="o">*</span> <span class="n">T22</span>
            <span class="p">)))</span>
        <span class="k">if</span> <span class="n">approx</span> <span class="o">==</span> <span class="s2">&quot;secular + pseudosecular&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">QunObj</span><span class="p">(</span><span class="n">A0</span> <span class="o">*</span> <span class="n">T0</span> <span class="o">+</span> <span class="n">A10</span> <span class="o">*</span> <span class="n">T10</span> <span class="o">+</span> <span class="n">A20</span> <span class="o">*</span> <span class="n">T20</span><span class="p">)</span></div>

        
<div class="viewcode-block" id="Hamiltonian.Interaction_Hamiltonian_LAB_CSA_Secular">
<a class="viewcode-back" href="../../modules.html#Source_Doc.PyOR_Hamiltonian.Hamiltonian.Interaction_Hamiltonian_LAB_CSA_Secular">[docs]</a>
    <span class="k">def</span> <span class="nf">Interaction_Hamiltonian_LAB_CSA_Secular</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">ApasQ</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">phi</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructs the secular CSA Hamiltonian in the lab frame.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        X : str</span>
<span class="sd">            Spin label (e.g., &#39;I&#39; or &#39;S&#39;)</span>
<span class="sd">        ApasQ : QunObj</span>
<span class="sd">            CSA tensor in PAF (principal axis frame)</span>
<span class="sd">        theta : float</span>
<span class="sd">            Polar angle in degrees</span>
<span class="sd">        phi : float</span>
<span class="sd">            Azimuthal angle in degrees</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        QunObj</span>
<span class="sd">            The secular CSA Hamiltonian component.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Apas</span> <span class="o">=</span> <span class="n">ApasQ</span><span class="o">.</span><span class="n">data</span>
        <span class="n">gamma</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">gamma</span>
        <span class="n">SZ</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="p">,</span> <span class="n">X</span> <span class="o">+</span> <span class="s2">&quot;z&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>

        <span class="n">theta</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">theta</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">phi</span>

        <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">InteractionTensor_PAF_Decomposition</span><span class="p">(</span><span class="n">ApasQ</span><span class="p">)</span>
        <span class="n">Isotropic</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="s2">&quot;Isotropic&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
        <span class="n">Anisotropy</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="s2">&quot;Anisotropy&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
        <span class="n">Asymmetry</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="s2">&quot;Asymmetry&quot;</span><span class="p">]</span>

        <span class="n">rho_lab_zz</span> <span class="o">=</span> <span class="n">Isotropic</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">Anisotropy</span> <span class="o">*</span> <span class="p">(</span>
            <span class="mf">3.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">Asymmetry</span> <span class="o">*</span> <span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">phi</span><span class="p">))</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">InteractioTensor_AngularFrequency</span><span class="p">:</span> <span class="c1"># Isotropic and Anisotropy are in angular frequency units</span>
            <span class="k">return</span> <span class="n">QunObj</span><span class="p">(</span><span class="n">rho_lab_zz</span>  <span class="o">*</span> <span class="n">SZ</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">QunObj</span><span class="p">(</span><span class="n">gamma</span> <span class="o">*</span> <span class="n">rho_lab_zz</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">B0</span> <span class="o">*</span> <span class="n">SZ</span><span class="p">)</span></div>


<div class="viewcode-block" id="Hamiltonian.Interaction_Hamiltonian_LAB_Quadrupole_Secular">
<a class="viewcode-back" href="../../modules.html#Source_Doc.PyOR_Hamiltonian.Hamiltonian.Interaction_Hamiltonian_LAB_Quadrupole_Secular">[docs]</a>
    <span class="k">def</span> <span class="nf">Interaction_Hamiltonian_LAB_Quadrupole_Secular</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Coupling</span><span class="p">,</span> <span class="n">etaQ</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">phi</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructs the secular quadrupole Hamiltonian.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        X : str</span>
<span class="sd">            Nucleus label</span>
<span class="sd">        eq : float</span>
<span class="sd">            Electric field gradient</span>
<span class="sd">        etaQ : float</span>
<span class="sd">            Quadrupolar asymmetry parameter</span>
<span class="sd">        theta, phi : float</span>
<span class="sd">            Orientation angles in degrees</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        QunObj</span>
<span class="sd">            The quadrupole Hamiltonian</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">Coupling</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">Coupling</span>
        <span class="n">spin</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">spin</span>

        <span class="n">constant</span> <span class="o">=</span> <span class="n">Coupling</span> <span class="o">/</span> <span class="p">(</span><span class="mf">4.0</span> <span class="o">*</span> <span class="n">spin</span> <span class="o">*</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">spin</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>

        <span class="n">Sx</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="p">,</span> <span class="n">X</span> <span class="o">+</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
        <span class="n">Sy</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="p">,</span> <span class="n">X</span> <span class="o">+</span> <span class="s2">&quot;y&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
        <span class="n">Sz</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="p">,</span> <span class="n">X</span> <span class="o">+</span> <span class="s2">&quot;z&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>

        <span class="n">theta</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">theta</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">phi</span>

        <span class="k">return</span> <span class="n">QunObj</span><span class="p">(</span>
            <span class="n">constant</span> <span class="o">*</span> <span class="p">(</span><span class="mf">3.0</span> <span class="o">*</span> <span class="n">Sz</span> <span class="o">@</span> <span class="n">Sz</span> <span class="o">-</span> <span class="p">(</span><span class="n">Sx</span> <span class="o">@</span> <span class="n">Sx</span> <span class="o">+</span> <span class="n">Sy</span> <span class="o">@</span> <span class="n">Sy</span> <span class="o">+</span> <span class="n">Sz</span> <span class="o">@</span> <span class="n">Sz</span><span class="p">))</span> <span class="o">*</span>
            <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="mf">3.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">etaQ</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">phi</span><span class="p">))</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="Hamiltonian.InteractionTensor_LAB">
<a class="viewcode-back" href="../../modules.html#Source_Doc.PyOR_Hamiltonian.Hamiltonian.InteractionTensor_LAB">[docs]</a>
    <span class="k">def</span> <span class="nf">InteractionTensor_LAB</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ApafQ</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Rotates a tensor from PAF to LAB frame using spherical tensors and Wigner rotation.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        ApafQ : QunObj</span>
<span class="sd">            Tensor in principal axis frame</span>
<span class="sd">        alpha, beta, gamma : float</span>
<span class="sd">            Euler angles</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        QunObj</span>
<span class="sd">            Rotated tensor in LAB frame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Sptensor</span> <span class="o">=</span> <span class="n">ST</span><span class="o">.</span><span class="n">MatrixToSphericalTensors</span><span class="p">(</span><span class="n">ApafQ</span><span class="p">)</span>
        <span class="n">T0</span> <span class="o">=</span> <span class="n">Sptensor</span><span class="p">[</span><span class="s2">&quot;rank0&quot;</span><span class="p">]</span>
        <span class="n">T11</span><span class="p">,</span> <span class="n">T10</span><span class="p">,</span> <span class="n">T1m1</span> <span class="o">=</span> <span class="n">Sptensor</span><span class="p">[</span><span class="s2">&quot;rank1&quot;</span><span class="p">]</span>
        <span class="n">T22</span><span class="p">,</span> <span class="n">T21</span><span class="p">,</span> <span class="n">T20</span><span class="p">,</span> <span class="n">T2m1</span><span class="p">,</span> <span class="n">T2m2</span> <span class="o">=</span> <span class="n">Sptensor</span><span class="p">[</span><span class="s2">&quot;rank2&quot;</span><span class="p">]</span>

        <span class="n">Wigner_rank1</span> <span class="o">=</span> <span class="n">PyOR_Rotation</span><span class="o">.</span><span class="n">Wigner_D_Matrix</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span><span class="p">)</span>
        <span class="n">Wigner_rank2</span> <span class="o">=</span> <span class="n">PyOR_Rotation</span><span class="o">.</span><span class="n">Wigner_D_Matrix</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span><span class="p">)</span>

        <span class="n">Rot_rank1</span> <span class="o">=</span> <span class="n">Wigner_rank1</span><span class="o">.</span><span class="n">data</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">T11</span><span class="p">],</span> <span class="p">[</span><span class="n">T10</span><span class="p">],</span> <span class="p">[</span><span class="n">T1m1</span><span class="p">]])</span>
        <span class="n">Rot_rank2</span> <span class="o">=</span> <span class="n">Wigner_rank2</span><span class="o">.</span><span class="n">data</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">T22</span><span class="p">],</span> <span class="p">[</span><span class="n">T21</span><span class="p">],</span> <span class="p">[</span><span class="n">T20</span><span class="p">],</span> <span class="p">[</span><span class="n">T2m1</span><span class="p">],</span> <span class="p">[</span><span class="n">T2m2</span><span class="p">]])</span>

        <span class="n">Sptensor_f</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;rank0&quot;</span><span class="p">:</span> <span class="n">T0</span><span class="p">,</span>
            <span class="s2">&quot;rank1&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Rot_rank1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Rot_rank1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">Rot_rank1</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span>
            <span class="s2">&quot;rank2&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Rot_rank2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Rot_rank2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">Rot_rank2</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">Rot_rank2</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">Rot_rank2</span><span class="p">[</span><span class="mi">4</span><span class="p">]]</span>
        <span class="p">}</span>

        <span class="n">AQ</span> <span class="o">=</span> <span class="n">ST</span><span class="o">.</span><span class="n">SphericalTensorsToMatrix</span><span class="p">(</span><span class="n">Sptensor_f</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">AQ</span></div>


<div class="viewcode-block" id="Hamiltonian.InteractionTensor_PAF_CSA">
<a class="viewcode-back" href="../../modules.html#Source_Doc.PyOR_Hamiltonian.Hamiltonian.InteractionTensor_PAF_CSA">[docs]</a>
    <span class="k">def</span> <span class="nf">InteractionTensor_PAF_CSA</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Iso</span><span class="p">,</span> <span class="n">Aniso</span><span class="p">,</span> <span class="n">Asymmetry</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructs the CSA interaction tensor in the principal axis frame (PAF).</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        Iso : float</span>
<span class="sd">            Isotropic component</span>
<span class="sd">        Aniso : float</span>
<span class="sd">            Anisotropy (Azz - Iso)</span>
<span class="sd">        Asymmetry : float</span>
<span class="sd">            Asymmetry parameter (eta = (Ayy - Axx) / Aniso),  range from 0 &lt;= eta &lt;= 1</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        QunObj</span>
<span class="sd">            3x3 CSA tensor in PAF</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">InteractioTensor_AngularFrequency</span><span class="p">:</span> <span class="c1"># Isotropic and Anisotropy are in angular frequency units</span>
            <span class="n">Iso</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">Iso</span>
            <span class="n">Aniso</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">Aniso</span>

        <span class="n">I1</span> <span class="o">=</span> <span class="n">Iso</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">I2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">I2</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">Asymmetry</span><span class="p">)</span>
        <span class="n">I2</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">Asymmetry</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">QunObj</span><span class="p">(</span><span class="n">I1</span> <span class="o">+</span> <span class="n">Aniso</span> <span class="o">*</span> <span class="n">I2</span><span class="p">)</span></div>


<div class="viewcode-block" id="Hamiltonian.InteractionTensor_PAF_Quadrupole">
<a class="viewcode-back" href="../../modules.html#Source_Doc.PyOR_Hamiltonian.Hamiltonian.InteractionTensor_PAF_Quadrupole">[docs]</a>
    <span class="k">def</span> <span class="nf">InteractionTensor_PAF_Quadrupole</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Coupling</span><span class="p">,</span> <span class="n">etaQ</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructs the quadrupolar tensor in the PAF.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        X : str</span>
<span class="sd">            Spin label</span>
<span class="sd">        eq : float</span>
<span class="sd">            Electric field gradient</span>
<span class="sd">        etaQ : float</span>
<span class="sd">            Quadrupolar asymmetry parameter</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        QunObj</span>
<span class="sd">            Quadrupolar tensor in the PAF</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">Coupling</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">Coupling</span>
        <span class="n">spin</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">spin</span>

        <span class="n">constant</span> <span class="o">=</span> <span class="n">Coupling</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">spin</span> <span class="o">*</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">spin</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>

        <span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">I</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">etaQ</span><span class="p">)</span> <span class="o">*</span> <span class="n">constant</span>
        <span class="n">I</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">etaQ</span><span class="p">)</span> <span class="o">*</span> <span class="n">constant</span>
        <span class="n">I</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">constant</span>

        <span class="k">return</span> <span class="n">QunObj</span><span class="p">(</span><span class="n">I</span><span class="p">)</span></div>


<div class="viewcode-block" id="Hamiltonian.InteractionTensor_PAF_Dipole">
<a class="viewcode-back" href="../../modules.html#Source_Doc.PyOR_Hamiltonian.Hamiltonian.InteractionTensor_PAF_Dipole">[docs]</a>
    <span class="k">def</span> <span class="nf">InteractionTensor_PAF_Dipole</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructs a PAF dipolar tensor.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        d : float</span>
<span class="sd">            Dipolar coupling constant (in Hz)</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        QunObj</span>
<span class="sd">            Dipolar tensor in the PAF</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">d</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">d</span>

        <span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">I</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span>
        <span class="n">I</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span>
        <span class="n">I</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">d</span>

        <span class="k">return</span> <span class="n">QunObj</span><span class="p">(</span><span class="n">I</span><span class="p">)</span></div>


<div class="viewcode-block" id="Hamiltonian.InteractionTensor_PAF_Decomposition">
<a class="viewcode-back" href="../../modules.html#Source_Doc.PyOR_Hamiltonian.Hamiltonian.InteractionTensor_PAF_Decomposition">[docs]</a>
    <span class="k">def</span> <span class="nf">InteractionTensor_PAF_Decomposition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">AQ</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Decomposes a PAF tensor into isotropic, anisotropy, and asymmetry components.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        AQ : QunObj</span>
<span class="sd">            Tensor to decompose</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        dict</span>
<span class="sd">            Dictionary with keys: &quot;Isotropic&quot;, &quot;Anisotropy&quot;, &quot;Asymmetry&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">AQ</span><span class="o">.</span><span class="n">data</span>
        <span class="n">output</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Matrix A must be square&quot;</span><span class="p">)</span>

        <span class="n">trace_A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
        <span class="n">A_iso</span> <span class="o">=</span> <span class="n">trace_A</span> <span class="o">/</span> <span class="mi">3</span>
        <span class="n">output</span><span class="p">[</span><span class="s2">&quot;Isotropic&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">A_iso</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span>

        <span class="n">aniso</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">A_iso</span>
        <span class="n">output</span><span class="p">[</span><span class="s2">&quot;Anisotropy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">aniso</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span>

        <span class="n">asymm</span> <span class="o">=</span> <span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">A_iso</span><span class="p">)</span>
        <span class="n">output</span><span class="p">[</span><span class="s2">&quot;Asymmetry&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">asymm</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">output</span></div>


<div class="viewcode-block" id="Hamiltonian.InteractionTensor_LAB_Decomposition">
<a class="viewcode-back" href="../../modules.html#Source_Doc.PyOR_Hamiltonian.Hamiltonian.InteractionTensor_LAB_Decomposition">[docs]</a>
    <span class="k">def</span> <span class="nf">InteractionTensor_LAB_Decomposition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">AQ</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Decomposes a LAB-frame tensor into isotropic, symmetric, and antisymmetric parts.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        AQ : QunObj</span>
<span class="sd">            LAB-frame tensor</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        dict</span>
<span class="sd">            Dictionary with QunObj entries:</span>
<span class="sd">            &quot;Isotropic&quot;, &quot;Symmetric&quot;, &quot;Antisymmetric&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">AQ</span><span class="o">.</span><span class="n">data</span>

        <span class="k">if</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Matrix A must be square&quot;</span><span class="p">)</span>

        <span class="n">output</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">trace_A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
        <span class="n">A_iso</span> <span class="o">=</span> <span class="p">(</span><span class="n">trace_A</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">output</span><span class="p">[</span><span class="s2">&quot;Isotropic&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">QunObj</span><span class="p">(</span><span class="n">A_iso</span><span class="p">)</span>

        <span class="n">A_sym</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">A</span> <span class="o">+</span> <span class="n">A</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">output</span><span class="p">[</span><span class="s2">&quot;Symmetric&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">QunObj</span><span class="p">(</span><span class="n">A_sym</span><span class="p">)</span>

        <span class="n">A_asym</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">A</span> <span class="o">-</span> <span class="n">A</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">output</span><span class="p">[</span><span class="s2">&quot;Antisymmetric&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">QunObj</span><span class="p">(</span><span class="n">A_asym</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">output</span></div>


<div class="viewcode-block" id="Hamiltonian.PowderSpectrum">
<a class="viewcode-back" href="../../modules.html#Source_Doc.PyOR_Hamiltonian.Hamiltonian.PowderSpectrum">[docs]</a>
    <span class="k">def</span> <span class="nf">PowderSpectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">EVol</span><span class="p">,</span> <span class="n">rhoI</span><span class="p">,</span> <span class="n">rhoeq</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">IT_PAF</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">string</span><span class="p">,</span> <span class="n">approx</span><span class="p">,</span>
                    <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">weighted</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">SecularEquation</span><span class="o">=</span><span class="s2">&quot;spherical&quot;</span><span class="p">,</span> <span class="n">ncores</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">apodization</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the powder-averaged spectrum over (alpha, beta, gamma) angles.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        weighted : bool</span>
<span class="sd">            Whether to use weighted averaging.</span>
<span class="sd">        weight : ndarray or None</span>
<span class="sd">            Optional crystallite weights. If None and weighted=True,</span>
<span class="sd">            defaults to sin(beta) weighting.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        freq : ndarray</span>
<span class="sd">            Frequency axis.</span>
<span class="sd">        spectrum : ndarray</span>
<span class="sd">            Powder-averaged spectrum (absolute value).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">alpha_beta_gamma_pairs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">compute_single</span><span class="p">(</span><span class="n">alpha_i</span><span class="p">,</span> <span class="n">beta_i</span><span class="p">,</span> <span class="n">gamma_i</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">SecularEquation</span> <span class="o">==</span> <span class="s2">&quot;spherical&quot;</span><span class="p">:</span>
                <span class="n">HAM</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Interaction_Hamiltonian_SphericalTensor</span><span class="p">(</span>
                    <span class="n">X</span><span class="p">,</span> <span class="n">IT_PAF</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">string</span><span class="p">,</span> <span class="n">approx</span><span class="p">,</span> <span class="n">alpha_i</span><span class="p">,</span> <span class="n">beta_i</span><span class="p">,</span> <span class="n">gamma_i</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">SecularEquation</span> <span class="o">==</span> <span class="s2">&quot;csa&quot;</span><span class="p">:</span>
                <span class="n">HAM</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Interaction_Hamiltonian_LAB_CSA_Secular</span><span class="p">(</span>
                    <span class="n">X</span><span class="p">,</span> <span class="n">IT_PAF</span><span class="p">,</span> <span class="n">beta_i</span><span class="p">,</span> <span class="n">alpha_i</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown SecularEquation: </span><span class="si">{</span><span class="n">SecularEquation</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">t</span><span class="p">,</span> <span class="n">rho_t</span> <span class="o">=</span> <span class="n">EVol</span><span class="o">.</span><span class="n">Evolution</span><span class="p">(</span><span class="n">rhoI</span><span class="p">,</span> <span class="n">rhoeq</span><span class="p">,</span> <span class="n">HAM</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">Y</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="ow">or</span> <span class="n">Y</span> <span class="o">==</span> <span class="n">X</span><span class="p">:</span>
                <span class="n">det_Mt</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="p">,</span> <span class="n">X</span> <span class="o">+</span> <span class="s2">&quot;p&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">det_Mt</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="p">,</span> <span class="n">X</span> <span class="o">+</span> <span class="s2">&quot;p&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span> <span class="o">+</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="p">,</span> <span class="n">Y</span> <span class="o">+</span> <span class="s2">&quot;p&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>

            <span class="n">t</span><span class="p">,</span> <span class="n">Mt</span> <span class="o">=</span> <span class="n">EVol</span><span class="o">.</span><span class="n">Expectation</span><span class="p">(</span><span class="n">rho_t</span><span class="p">,</span> <span class="n">det_Mt</span><span class="p">)</span>
            <span class="n">Mt</span> <span class="o">=</span> <span class="n">Spro</span><span class="o">.</span><span class="n">WindowFunction</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">Mt</span><span class="p">,</span> <span class="n">apodization</span><span class="p">)</span>
            <span class="n">freq</span><span class="p">,</span> <span class="n">spectrum_single</span> <span class="o">=</span> <span class="n">Spro</span><span class="o">.</span><span class="n">FourierTransform</span><span class="p">(</span><span class="n">Mt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">AcqFS</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">freq</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">spectrum_single</span><span class="p">)</span>

        <span class="c1"># Run all computations in parallel</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">ncores</span><span class="p">)(</span>
            <span class="n">delayed</span><span class="p">(</span><span class="n">compute_single</span><span class="p">)(</span><span class="n">alpha_i</span><span class="p">,</span> <span class="n">beta_i</span><span class="p">,</span> <span class="n">gamma_i</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">alpha_i</span><span class="p">,</span> <span class="n">beta_i</span><span class="p">,</span> <span class="n">gamma_i</span> <span class="ow">in</span> <span class="n">alpha_beta_gamma_pairs</span>
        <span class="p">)</span>

        <span class="n">freq_list</span><span class="p">,</span> <span class="n">spectra</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">results</span><span class="p">)</span>
        <span class="n">freq</span> <span class="o">=</span> <span class="n">freq_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># assume all same</span>

        <span class="k">if</span> <span class="n">weighted</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">weight</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Use external crystallite weight array</span>
                <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">weight</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Use sin(beta) weighting</span>
                <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">beta</span><span class="p">))</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>  <span class="c1"># Normalize</span>
            <span class="n">spectrum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">w</span> <span class="o">*</span> <span class="n">s</span> <span class="k">for</span> <span class="n">w</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">spectra</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Uniform averaging (not normalized)</span>
            <span class="n">spectrum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">spectra</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">freq</span><span class="p">,</span> <span class="n">spectrum</span></div>


<div class="viewcode-block" id="Hamiltonian.MASSpectrum2">
<a class="viewcode-back" href="../../modules.html#Source_Doc.PyOR_Hamiltonian.Hamiltonian.MASSpectrum2">[docs]</a>
    <span class="k">def</span> <span class="nf">MASSpectrum2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">EVol</span><span class="p">,</span> <span class="n">rhoI</span><span class="p">,</span> <span class="n">rhoeq</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">IT_PAF</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">string</span><span class="p">,</span> <span class="n">approx</span><span class="p">,</span>
                    <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">weighted</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">MagicAngle</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">RotortFrequency</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">ncores</span><span class="o">=-</span><span class="mi">2</span><span class="p">,</span> <span class="n">apodization</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        &lt;&lt;&lt;&lt; Attention: This function is slow. &gt;&gt;&gt;&gt;</span>

<span class="sd">        Computes the powder-averaged spectrum over (alpha, beta, gamma) angles.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        weighted : bool</span>
<span class="sd">            Whether to use weighted averaging.</span>
<span class="sd">        weight : ndarray or None</span>
<span class="sd">            Optional crystallite weights. If None and weighted=True,</span>
<span class="sd">            defaults to sin(beta) weighting.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        freq : ndarray</span>
<span class="sd">            Frequency axis.</span>
<span class="sd">        spectrum : ndarray</span>
<span class="sd">            Powder-averaged spectrum (absolute value).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">dt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">AcqDT</span>
        <span class="n">Npoints</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">AcqAQ</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">AcqDT</span><span class="p">)</span>

        <span class="n">RotortFrequency_rad</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">RotortFrequency</span>

        <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">Npoints</span><span class="p">,</span> <span class="n">Npoints</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">alpha_beta_gamma_pairs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">compute_single</span><span class="p">(</span><span class="n">alpha_i</span><span class="p">,</span> <span class="n">beta_i</span><span class="p">,</span> <span class="n">gamma_i</span><span class="p">):</span>
            <span class="n">MAS_Ham</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Npoints</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">Vdim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">Vdim</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">time_i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
                <span class="n">MAS_Ham</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Interaction_Hamiltonian_MAS_SphericalTensor</span><span class="p">(</span>
                    <span class="n">X</span><span class="p">,</span> <span class="n">IT_PAF</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">string</span><span class="p">,</span> <span class="n">approx</span><span class="p">,</span>
                    <span class="n">alpha</span><span class="o">=</span><span class="n">alpha_i</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="n">beta_i</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="n">gamma_i</span><span class="p">,</span>
                    <span class="n">alpha1</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                    <span class="n">beta1</span><span class="o">=</span><span class="n">MagicAngle</span><span class="p">,</span>
                    <span class="n">gamma1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">RotortFrequency_rad</span> <span class="o">*</span> <span class="n">time_i</span><span class="p">)</span>
                <span class="p">)</span><span class="o">.</span><span class="n">data</span>  <span class="c1"># Assuming QunObj wraps a .data matrix</span>

            <span class="c1"># Time evolution</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">rho_t</span> <span class="o">=</span> <span class="n">EVol</span><span class="o">.</span><span class="n">Evolution</span><span class="p">(</span><span class="n">rhoI</span><span class="p">,</span> <span class="n">rhoeq</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Zeeman_RotFrame</span><span class="p">(),</span> <span class="n">HamiltonianArray</span><span class="o">=</span><span class="n">MAS_Ham</span><span class="p">)</span>

            <span class="c1"># Detection operator</span>
            <span class="k">if</span> <span class="n">Y</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="ow">or</span> <span class="n">Y</span> <span class="o">==</span> <span class="n">X</span><span class="p">:</span>
                <span class="n">det_Mt</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="p">,</span> <span class="n">X</span> <span class="o">+</span> <span class="s2">&quot;p&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">det_Mt</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="p">,</span> <span class="n">X</span> <span class="o">+</span> <span class="s2">&quot;p&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span> <span class="o">+</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="p">,</span> <span class="n">Y</span> <span class="o">+</span> <span class="s2">&quot;p&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>

            <span class="n">_</span><span class="p">,</span> <span class="n">Mt</span> <span class="o">=</span> <span class="n">EVol</span><span class="o">.</span><span class="n">Expectation</span><span class="p">(</span><span class="n">rho_t</span><span class="p">,</span> <span class="n">det_Mt</span><span class="p">)</span>
            <span class="n">Mt</span> <span class="o">=</span> <span class="n">Spro</span><span class="o">.</span><span class="n">WindowFunction</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">Mt</span><span class="p">,</span> <span class="n">apodization</span><span class="p">)</span>
            <span class="n">freq</span><span class="p">,</span> <span class="n">spectrum_single</span> <span class="o">=</span> <span class="n">Spro</span><span class="o">.</span><span class="n">FourierTransform</span><span class="p">(</span><span class="n">Mt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">AcqFS</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">freq</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">spectrum_single</span><span class="p">)</span>

        <span class="c1"># Run in parallel</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">ncores</span><span class="p">)(</span>
            <span class="n">delayed</span><span class="p">(</span><span class="n">compute_single</span><span class="p">)(</span><span class="n">alpha_i</span><span class="p">,</span> <span class="n">beta_i</span><span class="p">,</span> <span class="n">gamma_i</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">alpha_i</span><span class="p">,</span> <span class="n">beta_i</span><span class="p">,</span> <span class="n">gamma_i</span> <span class="ow">in</span> <span class="n">alpha_beta_gamma_pairs</span>
        <span class="p">)</span>

        <span class="n">freq_list</span><span class="p">,</span> <span class="n">spectra</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">results</span><span class="p">)</span>
        <span class="n">freq</span> <span class="o">=</span> <span class="n">freq_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">weighted</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">weight</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">weight</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">beta</span><span class="p">))</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
            <span class="n">spectrum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">w</span> <span class="o">*</span> <span class="n">s</span> <span class="k">for</span> <span class="n">w</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">spectra</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">spectrum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">spectra</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">freq</span><span class="p">,</span> <span class="n">spectrum</span></div>


<div class="viewcode-block" id="Hamiltonian.MASSpectrum">
<a class="viewcode-back" href="../../modules.html#Source_Doc.PyOR_Hamiltonian.Hamiltonian.MASSpectrum">[docs]</a>
    <span class="k">def</span> <span class="nf">MASSpectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">EVol</span><span class="p">,</span> <span class="n">rhoI</span><span class="p">,</span> <span class="n">rhoeq</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">IT_PAF</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">string</span><span class="p">,</span> <span class="n">approx</span><span class="p">,</span>
                    <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">weighted</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">MagicAngle</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">RotortFrequency</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">ncores</span><span class="o">=-</span><span class="mi">2</span><span class="p">,</span> <span class="n">apodization</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the Magic Angle Spinning (MAS) powder-averaged spectrum.</span>

<span class="sd">        This function constructs a periodic time-dependent Hamiltonian array for MAS,</span>
<span class="sd">        evolving the system under that Hamiltonian, and computing the spectrum by Fourier transforming</span>
<span class="sd">        the expectation values.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        EVol : Evolution object</span>
<span class="sd">            Evolution class instance capable of time evolution.</span>
<span class="sd">        rhoI : ndarray</span>
<span class="sd">            Initial density matrix.</span>
<span class="sd">        rhoeq : ndarray</span>
<span class="sd">            Equilibrium density matrix.</span>
<span class="sd">        X : str</span>
<span class="sd">            Spin species (e.g., &quot;H&quot;, &quot;C&quot;).</span>
<span class="sd">        IT_PAF : ndarray</span>
<span class="sd">            Interaction tensor in principal axis frame (PAF).</span>
<span class="sd">        Y : str</span>
<span class="sd">            Secondary spin species for spin-spin interactions (can be empty for spin-field interactions).</span>
<span class="sd">        string : str</span>
<span class="sd">            Type of interaction: &quot;spin-field&quot; or &quot;spin-spin&quot;.</span>
<span class="sd">        approx : str</span>
<span class="sd">            Approximation method: &quot;all&quot;, &quot;secular&quot;, or &quot;secular + pseudosecular&quot;.</span>
<span class="sd">        alpha, beta, gamma : array-like</span>
<span class="sd">            Orientation angles (in radians) for the powder averaging.</span>
<span class="sd">        weighted : bool, optional</span>
<span class="sd">            Whether to use weighted averaging. Default is True.</span>
<span class="sd">        weight : ndarray, optional</span>
<span class="sd">            Weights for each crystallite orientation.</span>
<span class="sd">        MagicAngle : float, optional</span>
<span class="sd">            Magic angle value in degrees. Default is 0.</span>
<span class="sd">        RotortFrequency : float, optional</span>
<span class="sd">            Spinning frequency in Hz. Default is 0.</span>
<span class="sd">        ncores : int, optional</span>
<span class="sd">            Number of cores for parallelization. Default is -2 (use all but two cores).</span>
<span class="sd">        apodization : float, optional</span>
<span class="sd">            Apodization factor for windowing. Default is 0.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        freq : ndarray</span>
<span class="sd">            Frequency axis (Hz).</span>
<span class="sd">        spectrum : ndarray</span>
<span class="sd">            Powder-averaged spectrum (absolute value).</span>

<span class="sd">        Acknowledgements:</span>
<span class="sd">        -----------------</span>
<span class="sd">        1. Subhadip Pradhan, TIFR Hyderabad, for sharing the concept of using periodic Hamiltonian.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">dt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">AcqDT</span>
        <span class="n">Npoints</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">AcqAQ</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">AcqDT</span><span class="p">)</span>

        <span class="n">RotortFrequency_rad</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">RotortFrequency</span>

        <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">Npoints</span><span class="p">,</span> <span class="n">Npoints</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">alpha_beta_gamma_pairs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span><span class="p">))</span>

        <span class="c1"># Determine the number of Hamiltonians over a rotor period</span>
        <span class="n">num_H</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="p">(</span><span class="n">dt</span> <span class="o">*</span> <span class="n">RotortFrequency_rad</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Time points in one rotor period&quot;</span><span class="p">,</span> <span class="n">num_H</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">compute_single</span><span class="p">(</span><span class="n">alpha_i</span><span class="p">,</span> <span class="n">beta_i</span><span class="p">,</span> <span class="n">gamma_i</span><span class="p">):</span>
            <span class="c1"># Precompute the unique Hamiltonians</span>
            <span class="n">Ham_unique</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_H</span><span class="p">):</span>
                <span class="n">gamma1_k</span> <span class="o">=</span> <span class="n">RotortFrequency_rad</span> <span class="o">*</span> <span class="n">k</span> <span class="o">*</span> <span class="n">dt</span>
                <span class="n">H</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Interaction_Hamiltonian_MAS_SphericalTensor</span><span class="p">(</span>
                    <span class="n">X</span><span class="p">,</span> <span class="n">IT_PAF</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">string</span><span class="p">,</span> <span class="n">approx</span><span class="p">,</span>
                    <span class="n">alpha</span><span class="o">=</span><span class="n">alpha_i</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="n">beta_i</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="n">gamma_i</span><span class="p">,</span>
                    <span class="n">alpha1</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                    <span class="n">beta1</span><span class="o">=</span><span class="n">MagicAngle</span><span class="p">,</span>
                    <span class="n">gamma1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">gamma1_k</span><span class="p">)</span>
                <span class="p">)</span><span class="o">.</span><span class="n">data</span>
                <span class="n">Ham_unique</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">H</span><span class="p">)</span>

            <span class="c1"># Repeat the Hamiltonians periodically over all time points</span>
            <span class="n">MAS_Ham</span> <span class="o">=</span> <span class="p">[</span><span class="n">Ham_unique</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="n">num_H</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Npoints</span><span class="p">)]</span>

            <span class="c1"># Evolve the density matrix</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">rho_t</span> <span class="o">=</span> <span class="n">EVol</span><span class="o">.</span><span class="n">Evolution</span><span class="p">(</span><span class="n">rhoI</span><span class="p">,</span> <span class="n">rhoeq</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Zeeman_RotFrame</span><span class="p">(),</span> <span class="n">HamiltonianArray</span><span class="o">=</span><span class="n">MAS_Ham</span><span class="p">)</span>

            <span class="c1"># Setup detection operator</span>
            <span class="k">if</span> <span class="n">Y</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="ow">or</span> <span class="n">Y</span> <span class="o">==</span> <span class="n">X</span><span class="p">:</span>
                <span class="n">det_Mt</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="p">,</span> <span class="n">X</span> <span class="o">+</span> <span class="s2">&quot;p&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">det_Mt</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="p">,</span> <span class="n">X</span> <span class="o">+</span> <span class="s2">&quot;p&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span> <span class="o">+</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="p">,</span> <span class="n">Y</span> <span class="o">+</span> <span class="s2">&quot;p&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>

            <span class="c1"># Compute expectation values and apply window function</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">Mt</span> <span class="o">=</span> <span class="n">EVol</span><span class="o">.</span><span class="n">Expectation</span><span class="p">(</span><span class="n">rho_t</span><span class="p">,</span> <span class="n">det_Mt</span><span class="p">)</span>
            <span class="n">Mt</span> <span class="o">=</span> <span class="n">Spro</span><span class="o">.</span><span class="n">WindowFunction</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">Mt</span><span class="p">,</span> <span class="n">apodization</span><span class="p">)</span>

            <span class="c1"># Fourier transform to obtain the spectrum</span>
            <span class="n">freq</span><span class="p">,</span> <span class="n">spectrum_single</span> <span class="o">=</span> <span class="n">Spro</span><span class="o">.</span><span class="n">FourierTransform</span><span class="p">(</span><span class="n">Mt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_QS</span><span class="o">.</span><span class="n">AcqFS</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">freq</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">spectrum_single</span><span class="p">)</span>

        <span class="c1"># Compute the spectrum for each orientation in parallel</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">ncores</span><span class="p">)(</span>
            <span class="n">delayed</span><span class="p">(</span><span class="n">compute_single</span><span class="p">)(</span><span class="n">alpha_i</span><span class="p">,</span> <span class="n">beta_i</span><span class="p">,</span> <span class="n">gamma_i</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">alpha_i</span><span class="p">,</span> <span class="n">beta_i</span><span class="p">,</span> <span class="n">gamma_i</span> <span class="ow">in</span> <span class="n">alpha_beta_gamma_pairs</span>
        <span class="p">)</span>

        <span class="n">freq_list</span><span class="p">,</span> <span class="n">spectra</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">results</span><span class="p">)</span>
        <span class="n">freq</span> <span class="o">=</span> <span class="n">freq_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Perform weighted or unweighted averaging</span>
        <span class="k">if</span> <span class="n">weighted</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">weight</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">weight</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">beta</span><span class="p">))</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
            <span class="n">spectrum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">w</span> <span class="o">*</span> <span class="n">s</span> <span class="k">for</span> <span class="n">w</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">spectra</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">spectrum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">spectra</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">freq</span><span class="p">,</span> <span class="n">spectrum</span></div>


<div class="viewcode-block" id="Hamiltonian.ShapedPulse_Bruker">
<a class="viewcode-back" href="../../modules.html#Source_Doc.PyOR_Hamiltonian.Hamiltonian.ShapedPulse_Bruker">[docs]</a>
    <span class="k">def</span> <span class="nf">ShapedPulse_Bruker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">pulseLength</span><span class="p">,</span> <span class="n">RotationAngle</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load and process a shaped pulse from a Bruker shape file.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        file_path : str</span>
<span class="sd">            Path to the shaped pulse file (typically Bruker format)</span>
<span class="sd">        pulseLength : float</span>
<span class="sd">            Total length of the shaped pulse (in seconds)</span>
<span class="sd">        RotationAngle : float</span>
<span class="sd">            Desired rotation angle (in degrees)</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        tuple</span>
<span class="sd">            (time array, B1 amplitude over time, B1 phase over time)</span>

<span class="sd">        References:</span>
<span class="sd">        -----------</span>
<span class="sd">        - Bruker Shape Tool manual</span>
<span class="sd">        - https://github.com/modernscientist/...</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nu1_hard_pulseLength</span> <span class="o">=</span> <span class="n">RotationAngle</span> <span class="o">/</span> <span class="p">(</span><span class="mf">360.0</span> <span class="o">*</span> <span class="n">pulseLength</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Nutation frequency of hard pulse (Hz):&quot;</span><span class="p">,</span> <span class="n">nu1_hard_pulseLength</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">pulseString</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

        <span class="n">pulseShapeArray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">StringIO</span><span class="p">(</span><span class="n">pulseString</span><span class="p">),</span> <span class="n">comments</span><span class="o">=</span><span class="s1">&#39;#&#39;</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="n">n_pulse</span> <span class="o">=</span> <span class="n">pulseShapeArray</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">pulseShapeInten</span> <span class="o">=</span> <span class="n">pulseShapeArray</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">pulseShapeArray</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]))</span>
        <span class="n">pulseShapePhase</span> <span class="o">=</span> <span class="n">pulseShapeArray</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">180</span>

        <span class="n">xPulseShape</span> <span class="o">=</span> <span class="n">pulseShapeInten</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">pulseShapePhase</span><span class="p">)</span>
        <span class="n">yPulseShape</span> <span class="o">=</span> <span class="n">pulseShapeInten</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">pulseShapePhase</span><span class="p">)</span>
        <span class="n">scalingFactor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">xPulseShape</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_pulse</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Scaling Factor:&quot;</span><span class="p">,</span> <span class="n">scalingFactor</span><span class="p">)</span>

        <span class="n">nuB1max</span> <span class="o">=</span> <span class="n">nu1_hard_pulseLength</span> <span class="o">/</span> <span class="n">scalingFactor</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Maximum nuB1 (Hz):&quot;</span><span class="p">,</span> <span class="n">nuB1max</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Period corresponding to maximum nuB1 (s):&quot;</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">nuB1max</span><span class="p">)</span>

        <span class="n">time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">pulseLength</span><span class="p">,</span> <span class="n">n_pulse</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">time</span><span class="p">,</span> <span class="n">nuB1max</span> <span class="o">*</span> <span class="n">pulseShapeInten</span><span class="p">,</span> <span class="n">pulseShapePhase</span></div>


<div class="viewcode-block" id="Hamiltonian.ShapedPulse_Interpolate">
<a class="viewcode-back" href="../../modules.html#Source_Doc.PyOR_Hamiltonian.Hamiltonian.ShapedPulse_Interpolate">[docs]</a>
    <span class="k">def</span> <span class="nf">ShapedPulse_Interpolate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">SPIntensity</span><span class="p">,</span> <span class="n">SPPhase</span><span class="p">,</span> <span class="n">Kind</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Interpolate amplitude and phase arrays of a shaped pulse.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        time : array</span>
<span class="sd">            Time axis of the pulse shape</span>
<span class="sd">        SPIntensity : array</span>
<span class="sd">            Amplitude values of the pulse shape</span>
<span class="sd">        SPPhase : array</span>
<span class="sd">            Phase values of the pulse shape (radians)</span>
<span class="sd">        Kind : str</span>
<span class="sd">            Interpolation method (e.g., &#39;linear&#39;, &#39;cubic&#39;, etc.)</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        tuple</span>
<span class="sd">            (amplitude interpolator, phase interpolator)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">interp1d</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">SPIntensity</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="n">Kind</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="s2">&quot;extrapolate&quot;</span><span class="p">),</span>
            <span class="n">interp1d</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">SPPhase</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="n">Kind</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="s2">&quot;extrapolate&quot;</span><span class="p">)</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="Hamiltonian.Eigen">
<a class="viewcode-back" href="../../modules.html#Source_Doc.PyOR_Hamiltonian.Hamiltonian.Eigen">[docs]</a>
    <span class="k">def</span> <span class="nf">Eigen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">H</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute eigenvalues and eigenvectors of a Hamiltonian.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        H : np.ndarray</span>
<span class="sd">            Hamiltonian matrix</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        tuple</span>
<span class="sd">            (eigenvalues, eigenvectors)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">eigenvalues</span><span class="p">,</span> <span class="n">eigenvectors</span> <span class="o">=</span> <span class="n">lina</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">H</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">eigenvalues</span><span class="p">,</span> <span class="n">eigenvectors</span></div>
</div>




</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Vineeth Francis Thalakottoor Jose Chacko.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>